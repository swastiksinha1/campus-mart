<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CampusMart - The Ultimate Student Marketplace</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ“</text></svg>">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lexend:wght@500;600;700;800&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  darkMode: 'class',
  theme: {
    extend: {
      fontFamily: {
        'inter': ['Inter', 'sans-serif'],
        'lexend': ['Lexend', 'sans-serif'],
      },
      colors: {
        'primary': {
          '50': '#eff6ff', '100': '#dbeafe', '200': '#bfdbfe', '300': '#93c5fd', '400': '#60a5fa',
          '500': '#3b82f6', '600': '#2563eb', '700': '#1d4ed8', '800': '#1e40af', '900': '#1e3a8a'
        },
      }
    }
  }
}
</script>
<style>
body {
  font-family: 'Inter', sans-serif;
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
h1, h2, h3, h4, h5, h6 {
  font-family: 'Lexend', sans-serif;
}
.tab-content { display: none; }
.tab-content.active { display: block; }

.nav-item {
  position: relative;
  transition: color 0.3s ease-in-out, transform 0.2s ease-in-out;
  padding-bottom: 4px;
}
.nav-item::after {
  content: '';
  position: absolute;
  width: 100%;
  transform: scaleX(0);
  height: 2px;
  bottom: 0;
  left: 0;
  background-color: #2563eb;
  transform-origin: bottom right;
  transition: transform 0.3s ease-in-out;
}
.dark .nav-item::after { background-color: #60a5fa; }
.nav-item:hover {
  transform: translateY(-2px) scale(1.05);
}
.nav-item:hover::after {
  transform: scaleX(1);
  transform-origin: bottom left;
}
.nav-item.active {
  color: #2563eb;
  font-weight: 600;
}
.dark .nav-item.active { color: #60a5fa; }
.nav-item.active::after {
  transform: scaleX(1);
  transform-origin: bottom left;
}

.modal { transition: opacity 0.3s ease, visibility 0.3s ease; opacity: 0; visibility: hidden; }
.modal.show { opacity: 1; visibility: visible; }
.modal-content { transition: transform 0.3s ease; transform: translateY(20px) scale(0.95); }
.modal.show .modal-content { transform: translateY(0) scale(1); }

#image-drop-zone, #pfp-drop-zone, #lost-found-drop-zone, #trade-offer-drop-zone { border: 2px dashed #d1d5db; transition: background-color 0.2s, border-color 0.2s; }
#image-drop-zone.drag-over, #pfp-drop-zone.drag-over, #lost-found-drop-zone.drag-over, #trade-offer-drop-zone.drag-over { background-color: #eff6ff; border-color: #2563eb; }
.dark #image-drop-zone, .dark #pfp-drop-zone, .dark #lost-found-drop-zone, .dark #trade-offer-drop-zone { border-color: #4b5563; }
.dark #image-drop-zone.drag-over, .dark #pfp-drop-zone.drag-over, .dark #lost-found-drop-zone.drag-over, .dark #trade-offer-drop-zone.drag-over { background-color: #1e3a8a; border-color: #60a5fa; }

#cart-drawer { transform: translateX(100%); transition: transform 0.3s ease-in-out; }
#cart-drawer.open { transform: translateX(0); }

#welcome-overlay {
  background: linear-gradient(-45deg, #1d4ed8, #2563eb, #3b82f6, #1e3a8a);
  background-size: 400% 400%;
  animation: animate-gradient 10s ease infinite;
}
#welcome-overlay .welcome-icon { animation: icon-pop-in 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
#welcome-overlay .welcome-title { animation: text-stagger-in 1s ease-out 0.2s forwards; opacity: 0; }
#welcome-overlay .welcome-subtitle { animation: text-stagger-in 1s ease-out 0.4s forwards; opacity: 0; }

@keyframes animate-gradient {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
@keyframes icon-pop-in {
  0% { transform: scale(0.5) rotate(-15deg); opacity: 0; }
  60% { transform: scale(1.2) rotate(5deg); opacity: 1; }
  80% { transform: scale(0.95) rotate(-2deg); }
  100% { transform: scale(1) rotate(0deg); opacity: 1; }
}
@keyframes text-stagger-in {
  from { opacity: 0; transform: translateY(25px); }
  to { opacity: 1; transform: translateY(0); }
}

.animate-tab-content { animation: tab-fade-in 0.5s ease-out forwards; }
@keyframes tab-fade-in {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.confetti {
  position: fixed; width: 10px; height: 10px;
  background-color: var(--color); opacity: 1; z-index: 1000;
  pointer-events: none; animation: pop-and-fade 2s ease-out forwards;
}
@keyframes pop-and-fade {
  0% { transform: translate(0, 0) rotate(0deg); opacity: 1; }
  100% { transform: translate(var(--x), var(--y)) rotate(720deg); opacity: 0; }
}

.animated-btn {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.animated-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 15px rgba(59, 130, 246, 0.3);
}
.animated-btn:active {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
}

.fade-in-section { opacity: 0; transform: translateY(20px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
.fade-in-section.is-visible { opacity: 1; transform: translateY(0); }

.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

.skeleton-card {
  background-color: #fff;
  border-radius: 0.75rem;
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
  overflow: hidden;
}
.dark .skeleton-card { background-color: #1f2937; }
.skeleton-card .skeleton-img {
  height: 13rem;
  background-color: #e5e7eb;
}
.dark .skeleton-card .skeleton-img { background-color: #374151; }
.skeleton-card .skeleton-text {
  height: 1rem;
  margin-top: 0.75rem;
  border-radius: 0.25rem;
  background-color: #e5e7eb;
}
.dark .skeleton-card .skeleton-text { background-color: #4b5563; }
@keyframes pulse {
  50% { opacity: .5; }
}
.skeleton-card .skeleton-img, .skeleton-card .skeleton-text {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

.input-error {
  border-color: #ef4444 !important;
  box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
}
.error-message {
  color: #ef4444;
  font-size: 0.875rem;
  margin-top: 0.5rem;
}

.profile-pic-container {
  animation: pop-out-pfp 0.6s ease-out forwards;
}
@keyframes pop-out-pfp {
  from {
    transform: scale(0.8);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

.how-it-works-icon, .category-card-icon {
  display: inline-block;
  transition: transform 0.3s ease-in-out;
}
.group:hover .how-it-works-icon, .group:hover .category-card-icon {
  transform: scale(1.2) rotate(-8deg);
}

#popup-chat-widget {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  z-index: 45;
}
#popup-chat-container {
  position: fixed;
  bottom: 6rem;
  right: 2rem;
  width: 90%;
  max-width: 400px;
  height: 70vh;
  max-height: 500px;
  z-index: 45;
  transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
  transform: translateY(20px) scale(0.95);
  opacity: 0;
  pointer-events: none;
}
#popup-chat-container.open {
  transform: translateY(0) scale(1);
  opacity: 1;
  pointer-events: auto;
}

/* New Animation for Header Buttons */
@keyframes subtle-pop {
    0% { transform: scale(0.9); opacity: 0; }
    70% { transform: scale(1.05); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}
.animate-subtle-pop {
    animation: subtle-pop 0.4s ease-out forwards;
    opacity: 0; /* Start hidden */
}
/* Enhanced Category Card */
.category-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    border: 2px solid transparent;
    cursor: pointer;
}
.category-card:hover {
    transform: translateY(-5px) scale(1.03);
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    border-color: #60a5fa; /* Lighter primary border */
}
.dark .category-card:hover {
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
    border-color: #3b82f6;


}
</style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

<div id="auth-modal" class="modal fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
<div id="auth-modal-content" class="modal-content bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md"></div>
</div>

<div id="checkout-modal" class="modal fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
<div id="checkout-modal-content" class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md"></div>
</div>

<div id="confirm-modal" class="modal fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
<div id="confirm-modal-content" class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm p-6 text-center"></div>
</div>

<div id="profile-pic-modal" class="modal fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
<div id="profile-pic-modal-content" class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg"></div>
</div>

<div id="lost-and-found-modal" class="modal fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
<div id="lost-and-found-modal-content" class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg"></div>
</div>

<div id="trade-offer-modal" class="modal fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
<div id="trade-offer-modal-content" class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg"></div>
</div>

<div id="change-password-modal" class="modal fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
<div id="change-password-modal-content" class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md"></div>
</div>

<div id="terms-modal" class="modal fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 overflow-y-auto">
    <div id="terms-modal-content" class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl"></div>
</div>
<div id="privacy-modal" class="modal fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 overflow-y-auto">
    <div id="privacy-modal-content" class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl"></div>
</div>

<div id="welcome-overlay" class="modal fixed inset-0 flex items-center justify-center z-[60]"></div>

<div id="cart-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden transition-opacity duration-300"></div>
<div id="cart-drawer" class="fixed top-0 right-0 h-full w-full max-w-md bg-white dark:bg-gray-800 shadow-2xl z-50 flex flex-col"></div>

<div id="app-container" class="min-h-screen flex flex-col opacity-0 transition-opacity duration-500">
<header id="app-header" class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg py-4 px-4 sm:px-6 sticky top-0 z-30 transition-shadow duration-200">
<div class="container mx-auto flex justify-between items-center">
<button data-tab="home" class="text-2xl font-bold text-primary-600 dark:text-primary-400 flex items-center font-lexend">
<span class="mr-2 text-3xl">ðŸŽ“</span> CampusMart
</button>
<nav class="hidden sm:flex items-center space-x-8 text-gray-600 dark:text-gray-300 font-medium">
<button data-tab="home" class="nav-item">Home</button>
<button data-tab="buy" class="nav-item">Buy</button>
<button data-tab="trade" class="nav-item">Trade/Barter</button>
<button data-tab="sell" class="nav-item">Sell</button>
<button data-tab="lost-and-found" class="nav-item">Lost & Found</button>
<button data-tab="my-listings" class="nav-item">My Listings</button>
<button data-tab="orders" class="nav-item">My Orders</button>
</nav>
<div id="header-actions-container" class="flex items-center space-x-2 sm:space-x-4"></div>
</div>
</header>

<main class="flex-grow">
<div id="home-tab" class="tab-content"></div>
<div id="buy-tab" class="tab-content container mx-auto p-4 sm:p-6"></div>
<div id="trade-tab" class="tab-content container mx-auto p-4 sm:p-6"></div>
<div id="sell-tab" class="tab-content container mx-auto p-4 sm:p-6"></div>
<div id="lost-and-found-tab" class="tab-content container mx-auto p-4 sm:p-6"></div>
<div id="my-listings-tab" class="tab-content container mx-auto p-4 sm:p-6"></div>
<div id="orders-tab" class="tab-content container mx-auto p-4 sm:p-6"></div>
<div id="profile-tab" class="tab-content container mx-auto p-4 sm:p-6"></div>
<div id="product-detail-tab" class="tab-content"></div>
</main>

<footer class="bg-gray-800 dark:bg-gray-900 text-white">
<div class="container mx-auto py-8 px-6">
    <div class="flex flex-col md:flex-row justify-between items-center text-center md:text-left gap-6">
        <div class="text-sm text-gray-400 order-3 md:order-1">
            &copy; <span id="footer-date"></span> Campus Exchange. All rights reserved.
        </div>

        <div class="flex space-x-6 order-1 md:order-2">
            <a href="https://www.instagram.com/ig_swastik" target="_blank" rel="noopener noreferrer" aria-label="Instagram" class="text-gray-400 hover:text-primary-400 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.011 3.584-.069 4.85c-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.584-.012-4.85-.07c-3.252-.148-4.771-1.691-4.919-4.919-.058-1.265-.069-1.645-.069-4.85s.011-3.584.069-4.85c.149-3.225 1.664-4.771 4.919-4.919C8.416 2.175 8.796 2.163 12 2.163zm0 1.441c-3.171 0-3.543.012-4.78.068-2.733.124-3.958 1.348-4.082 4.082-.056 1.237-.068 1.612-.068 4.78s.012 3.543.068 4.78c.124 2.733 1.348 3.958 4.082 4.082 1.237.056 1.612.068 4.78.068s3.543-.012 4.78-.068c2.733-.124 3.958-1.348 4.082-4.082.056-1.237.068-1.612.068-4.78s-.012-3.543-.068-4.78c-.124-2.733-1.348-3.958-4.082-4.082-1.237-.056-1.612-.068-4.78-.068zm0 5.838a4.558 4.558 0 100 9.116 4.558 4.558 0 000-9.116zm0 7.232a2.674 2.674 0 110-5.348 2.674 2.674 0 010 5.348zm6.355-8.154a1.08 1.08 0 100 2.16 1.08 1.08 0 000-2.16z"></path>
                </svg>
            </a>
            <a href="https://twitter.com" target="_blank" rel="noopener noreferrer" aria-label="Twitter" class="text-gray-400 hover:text-primary-400 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616v.063c0 2.181 1.557 4.007 3.631 4.42-1.002.274-2.116.21-2.93.001.573 1.785 2.24 3.085 4.21 3.122-1.543 1.21-3.483 1.93-5.59 1.688-1.854.11-3.73-.29-5.46-1.22A16.096 16.096 0 0010.5 21.018c10.4 0 15.2-8.54 14.4-15.018.89-.636 1.66-1.42 2.28-2.31z"></path>
                </svg>
            </a>
        </div>

        <div class="flex space-x-6 text-sm text-gray-400 order-2 md:order-3">
            <button id="terms-link" class="hover:text-primary-400 transition-colors">Terms & Conditions</button>
            <button id="privacy-link" class="hover:text-primary-400 transition-colors">Privacy Policy</button>
            <div class="flex space-x-6 text-sm text-gray-400 order-2 md:order-3">
          
          <a href="mailto:swastiksinha001@gmail.com" class="hover:text-primary-400 transition-colors">Contact Support</a>
        </div>
        </div>
    </div>
</div>
</footer>

</div>

<div id="popup-chat-widget"></div>

<div id="message-container" class="fixed top-20 right-5 z-50 space-y-3"></div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

// --- Cloudinary Configuration ---
const CLOUDINARY_CLOUD_NAME = 'dlwb70n5s';
const CLOUDINARY_UPLOAD_PRESET = 'campus-exchange-uploads';

const firebaseConfig = {
  apiKey: "AIzaSyBqsgsbxvYViVPNLpiiKDrEyikHu76Wu4I",
  authDomain: "campusexchange-875ba.firebaseapp.com",
  projectId: "campusexchange-875ba",
  storageBucket: "campusexchange-875ba.appspot.com",
  messagingSenderId: "943624444799",
  appId: "1:943624444799:web:9fcb07a2dab871adc2d84a",
  measurementId: "G-S8K7PGVKM5"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- State Management ---
let currentUser = null;
let products = [];
let cart = {};
let orders = [];
let lostAndFoundItems = [];
let productUnsubscribe = () => {};
let cartUnsubscribe = () => {};
let ordersUnsubscribe = () => {};
let lostAndFoundUnsubscribe = () => {};
let offersUnsubscribe = () => {};
let uploadedProductFile = null;
let uploadedPfpFile = null;
let uploadedLostFoundFile = null;
let uploadedTradeOfferFile = null;
let selectedAvatarUrl = null;
let emailVerificationInterval = null;
let navigationHistory = ['home'];

// --- DOM Elements ---
const authModal = document.getElementById('auth-modal');
const authModalContent = document.getElementById('auth-modal-content');
const checkoutModal = document.getElementById('checkout-modal');
const checkoutModalContent = document.getElementById('checkout-modal-content');
const confirmModal = document.getElementById('confirm-modal');
const confirmModalContent = document.getElementById('confirm-modal-content');
const profilePicModal = document.getElementById('profile-pic-modal');
const profilePicModalContent = document.getElementById('profile-pic-modal-content');
const lostAndFoundModal = document.getElementById('lost-and-found-modal');
const lostAndFoundModalContent = document.getElementById('lost-and-found-modal-content');
const tradeOfferModal = document.getElementById('trade-offer-modal');
const tradeOfferModalContent = document.getElementById('trade-offer-modal-content');
const changePasswordModal = document.getElementById('change-password-modal');
const changePasswordModalContent = document.getElementById('change-password-modal-content');
const termsModal = document.getElementById('terms-modal');
const termsModalContent = document.getElementById('terms-modal-content');
const privacyModal = document.getElementById('privacy-modal');
const privacyModalContent = document.getElementById('privacy-modal-content');
const welcomeOverlay = document.getElementById('welcome-overlay');
const cartDrawer = document.getElementById('cart-drawer');
const cartOverlay = document.getElementById('cart-overlay');
const appContainer = document.getElementById('app-container');
const headerActionsContainer = document.getElementById('header-actions-container');
const messageContainer = document.getElementById('message-container');
const header = document.getElementById('app-header');
const popupChatWidget = document.getElementById('popup-chat-widget');

// --- Cloudinary Upload Function ---
const uploadToCloudinary = async (file) => {
  const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

  try {
    const response = await fetch(url, {
      method: 'POST',
      body: formData,
    });
    if (!response.ok) {
      throw new Error('Cloudinary upload failed.');
    }
    const data = await response.json();
    return data.secure_url;
  } catch (error) {
    console.error('Error uploading to Cloudinary:', error);
    showMessage('Image upload failed. Please try again.', 'error');
    return null;
  }
};

const BAD_WORDS = ['damn', 'hell', 'crap', 'ass', 'bitch', 'fool', 'idiot'];
const filterProfanity = (text) => {
  if (!text) return '';
  const regex = new RegExp(`\\b(${BAD_WORDS.join('|')})\\b`, 'gi');
  return text.replace(regex, match => '*'.repeat(match.length));
};

const campusBot = {
  uid: 'campus-bot-01',
  displayName: 'Campus Assistant',
  photoURL: 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ccircle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%2394a3b8%22/%3E%3Ctext x=%2250%22 y=%2268%22 font-size=%2250%22 text-anchor=%22middle%22 fill=%22white%22%3EðŸ¤–%3C/text%3E%3C/svg%3E',
  isBot: true
};

const chatbotIntents = [
    // --- Basic & Navigational Intents ---
    {
        name: 'greeting',
        keywords: [/hey/i, /hello/i, /hi/i, /yo/i],
        handler: (message) => {
            const userName = currentUser ? `, ${currentUser.displayName.split(' ')[0]}` : '';
            return `Hello${userName}! I'm the Campus Assistant. How can I help you navigate the marketplace today?`;
        }
    },
    {
       // Make sure the first intent in your chatbotIntents array looks EXACTLY like this.

    name: 'navigate',
    keywords: [/buy/i, /sell/i, /trade/i, /home/i, /profile/i, /orders/i, /go to/i, /show me/i, /take me to/i, /open/i, /lost and found/i, /my listings/i],
    handler: (message) => {
        const tabs = ['home', 'buy', 'sell', 'trade', 'lost and found', 'my listings', 'orders', 'profile'];
        for (const tab of tabs) {
            if (message.toLowerCase().includes(tab)) {
                const tabId = tab.replace(' ', '-');
                setActiveTab(tabId);
                // Close the chat window for a better user experience
                document.getElementById('popup-chat-container')?.classList.remove('open');
                document.getElementById('open-popup-chat-btn')?.classList.remove('hidden');
                return `Sure, taking you to the **${tab}** page.`;
            }
        }
        return "I can take you to Home, Buy, Sell, Trade, etc. Where would you like to go?";
    }
}, // <-- Don't forget the comma here before the next intent!
    

    // --- "How-To" & Explanatory Intents ---
    {
        name: 'explain_tab',
        keywords: [/what is the/i, /tell me about the/i, /how does .* work/i],
        handler: (message) => {
            const msg = message.toLowerCase();
            if (msg.includes('buy')) return "The **Buy** page is where you can browse, search, and filter all items listed for sale by other students.";
            if (msg.includes('sell')) return "On the **Sell** page, you can list your own items for sale. Just fill out the form with details and an image, set a price, and you're good to go!";
            if (msg.includes('trade')) return "The **Trade/Barter** page shows all items where the seller is open to trading instead of just selling for cash. You can make offers on these items.";
            if (msg.includes('lost and found')) return "The **Lost & Found** page is a campus bulletin board. You can report items you've lost or found to help reconnect them with their owners.";
            if (msg.includes('my listings')) return "The **My Listings** page shows you all the items you have personally put up for sale, separated into 'Available' and 'Sold' categories.";
            if (msg.includes('orders')) return "The **My Orders** page contains the history of all the purchases you've made through the site.";
            return "I can tell you about the Buy, Sell, Trade, Lost & Found, My Listings, or Orders pages. Which one are you interested in?";
        }
    },
    {
        name: 'how_to_list_item',
        keywords: [/how do I sell/i, /how do I list/i],
        handler: (message) => {
            setActiveTab('sell');
            document.getElementById('popup-chat-container')?.classList.remove('open');
            document.getElementById('open-popup-chat-btn')?.classList.remove('hidden');
            return "It's easy! I've taken you to the **Sell** page. Just fill in the product's name, description, price, and upload a clear photo.";
        }
    },

    // --- Data-Driven & User-Specific Intents ---
    {
        name: 'search_items_with_filter',
        keywords: [/find/i, /search for/i, /look for/i, /do you have/i],
        handler: (message) => {
            // Regex to find a query and an optional price filter
            // e.g., "find books under 500" or "find electronics over 2000"
            const priceMatch = message.match(/(under|over|less than|more than) â‚¹?(\d+)/i);
            let query = message.replace(/(find|search for|look for|do you have) (a|an|any|some)?/i, '').trim();
            
            if (priceMatch) {
                query = query.replace(priceMatch[0], '').trim(); // Remove the price part from the main query
            }

            if (!query) return "What item are you looking for? For example, say 'find a textbook under â‚¹500'.";
            
            setActiveTab('buy');
            setTimeout(() => {
                const searchInput = document.querySelector('#buy-tab #search-input');
                const priceInput = document.querySelector('#buy-tab #filter-price');
                if (searchInput) {
                    searchInput.value = query;
                    searchInput.dispatchEvent(new Event('input')); 
                }
                if (priceInput && priceMatch) {
                    const condition = priceMatch[1].toLowerCase();
                    const amount = parseInt(priceMatch[2]);
                    if (condition === 'under' || condition === 'less than') {
                        if (amount <= 500) priceInput.value = '0-500';
                        else if (amount <= 2000) priceInput.value = '500-2000';
                        else if (amount <= 5000) priceInput.value = '2000-5000';
                    } else if (condition === 'over' || condition === 'more than') {
                        if (amount >= 5000) priceInput.value = '5000-9999999';
                        else if (amount >= 2000) priceInput.value = '2000-5000';
                    }
                    priceInput.dispatchEvent(new Event('change'));
                }
            }, 100);

            return `I'm searching for "${query}" for you...`;
        }
    },
    {
        name: 'check_my_listings_status',
        keywords: [/my listings/i, /items I'm selling/i, /what am I selling/i],
        handler: (message) => {
            if (!currentUser) return "You need to be signed in to see your listings.";
            
            const myListings = products.filter(p => p.sellerId === currentUser.uid);
            if (myListings.length === 0) {
                return "You haven't listed any items for sale yet. Why not sell something today?";
            }
            
            const availableCount = myListings.filter(p => p.status === 'available').length;
            const soldCount = myListings.length - availableCount;
            
            setActiveTab('my-listings');
            document.getElementById('popup-chat-container')?.classList.remove('open');
            document.getElementById('open-popup-chat-btn')?.classList.remove('hidden');

            return `You have **${availableCount}** item(s) for sale and **${soldCount}** sold/traded item(s). I've opened the **My Listings** page for you.`;
        }
    },
    {
        name: 'check_orders',
        keywords: [/my orders/i, /order history/i, /my purchases/i],
        handler: (message) => {
            if (!currentUser) return "You need to be signed in to view your orders.";
            if (orders.length === 0) {
                setActiveTab('buy');
                return "You haven't placed any orders yet. I've taken you to the **Buy** page so you can browse!";
            } else {
                setActiveTab('orders');
                return `You have **${orders.length}** order(s) in your history. I've taken you to your orders page.`;
            }
        }
    },

    // --- General & Fallback Intents ---
    {
        name: 'help',
        keywords: [/help/i, /what can you do/i, /commands/i],
        handler: (message) => {
            return `I can help you with a few things! Try asking me:\n- "Tell me about the trade page"\n- "Find a backpack under â‚¹1000"\n- "Show me my listings"\n- "How do I sell an item?"`;
        }
    },
    {
        name: 'support_contact',
        keywords: [/contact/i, /support/i, /issue/i, /problem/i, /email/i],
        handler: (message) => {
            return "For support, you can contact the administrator at swastiksinha001@gmail.com.";
        }
    },
    {
        name: 'thank_you',
        keywords: [/thanks/i, /thank you/i, /thx/i],
        handler: (message) => {
            return "You're welcome! Happy to help. ðŸ˜Š";
        }
    }
];


// --- Helper & UI Functions ---
const getInitials = (name) => {
  if (!name) return '?';
  const parts = name.split(' ');
  if (parts.length > 1) return parts[0].charAt(0) + parts[parts.length - 1].charAt(0);
  return name.charAt(0);
};

const showMessage = (msg, type = 'success') => {
  const colors = type === 'success'
    ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'
    : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
  const el = document.createElement('div');
  el.className = `px-4 py-3 rounded-lg shadow-lg ${colors} transition-all duration-500 transform translate-x-full ease-out`;
  el.textContent = msg;
  messageContainer.appendChild(el);
  requestAnimationFrame(() => el.classList.remove('translate-x-full'));
  setTimeout(() => {
    el.classList.add('translate-x-full');
    el.addEventListener('transitionend', () => el.remove());
  }, 5000);
};

const setActiveTab = (tabName, isBackAction = false) => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
  document.querySelectorAll('.nav-item').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabName));
  document.querySelectorAll('[data-tab="profile"]').forEach(btn => btn.classList.toggle('ring-2', btn.dataset.tab === tabName));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active', 'animate-tab-content'));

  if (!isBackAction && navigationHistory[navigationHistory.length - 1] !== tabName) {
      navigationHistory.push(tabName);
  }

  if (offersUnsubscribe) offersUnsubscribe();

  const activeTab = document.getElementById(`${tabName}-tab`);
  if (activeTab) {
    switch(tabName) {
      case 'home': renderHomePage(); break;
      case 'buy': renderBuyPage(); break;
      case 'trade': renderTradePage(); break;
      case 'sell': renderSellPage(); break;
      case 'lost-and-found': renderLostAndFoundPage(); break;
      case 'my-listings': renderMyListingsPage(); break;
      case 'orders': renderOrdersPage(); break;
      case 'profile': renderProfilePage(); break;
      case 'product-detail': break;
    }
    activeTab.classList.add('active');
    setTimeout(() => activeTab.classList.add('animate-tab-content'), 10);
  }
};

const handleGoBack = () => {
    if (navigationHistory.length > 1) {
        navigationHistory.pop();
        const previousTab = navigationHistory[navigationHistory.length - 1];
        setActiveTab(previousTab, true);
    } else {
        setActiveTab('home');
    }
};

const getBackButtonHTML = (text = 'Back') => {
    if (navigationHistory.length <= 1 && navigationHistory[0] === 'home') return '';
    return `
    <button id="go-back-btn" class="mb-6 inline-flex items-center gap-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-sm font-semibold rounded-lg animated-btn hover:bg-gray-300 dark:hover:bg-gray-600">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
        ${text}
    </button>`;
};


const showConfirmModal = (message, onConfirm) => {
  confirmModalContent.innerHTML = `
    <p class="text-lg font-medium text-gray-900 dark:text-white mb-4">${message}</p>
    <div class="flex justify-center space-x-4">
      <button id="confirm-cancel" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg font-semibold animated-btn">Cancel</button>
      <button id="confirm-ok" class="px-6 py-2 bg-red-500 text-white rounded-lg font-semibold animated-btn">Confirm</button>
    </div>`;
  confirmModal.classList.add('show');
  document.getElementById('confirm-ok').focus();
  document.getElementById('confirm-ok').onclick = () => { onConfirm(); confirmModal.classList.remove('show'); };
  document.getElementById('confirm-cancel').onclick = () => confirmModal.classList.remove('show');
};

const validateInput = (input, validationFn, errorMessage) => {
  const errorEl = input.parentElement.querySelector('.error-message');
  if (!validationFn(input.value)) {
    input.classList.add('input-error');
    if (errorEl) {
      errorEl.textContent = errorMessage;
    } else {
      input.insertAdjacentHTML('afterend', `<p class="error-message">${errorMessage}</p>`);
    }
    return false;
  } else {
    input.classList.remove('input-error');
    if (errorEl) {
      errorEl.remove();
    }
    return true;
  }
};

const applyTheme = (theme) => {
  if (theme === 'dark') document.documentElement.classList.add('dark');
  else document.documentElement.classList.remove('dark');
};
const toggleTheme = () => {
  const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
  localStorage.setItem('theme', newTheme);
  applyTheme(newTheme);
};
applyTheme(localStorage.getItem('theme') || 'light');

const showWelcomeAnimation = (user) => {
  welcomeOverlay.innerHTML = `
    <div class="text-center text-white">
      <div class="welcome-icon text-7xl mb-4">ðŸŽ“</div>
      <h1 class="welcome-title text-5xl md:text-6xl font-bold font-lexend">Welcome, ${user.displayName.split(' ')[0]}!</h1>
      <p class="welcome-subtitle text-xl md:text-2xl mt-2 text-primary-200">Entering Campus Mart...</p>
    </div>`;
  welcomeOverlay.classList.add('show');
  setTimeout(() => {
    welcomeOverlay.classList.remove('show');
    appContainer.classList.remove('opacity-0');
  }, 2500);
};

const triggerConfetti = () => {
  const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
  for (let i = 0; i < 50; i++) {
    const particle = document.createElement('div');
    particle.classList.add('confetti');
    particle.style.left = `${window.innerWidth / 2}px`;
    particle.style.top = `${window.innerHeight / 2}px`;
    particle.style.setProperty('--color', colors[Math.floor(Math.random() * colors.length)]);
    const angle = Math.random() * 360;
    const distance = Math.random() * (window.innerWidth / 2);
    particle.style.setProperty('--x', `${Math.cos(angle * Math.PI / 180) * distance}px`);
    particle.style.setProperty('--y', `${Math.sin(angle * Math.PI / 180) * distance}px`);
    document.body.appendChild(particle);
    setTimeout(() => particle.remove(), 2000);
  }
};

const setupScrollAnimations = () => {
  const faders = document.querySelectorAll('.fade-in-section');
  const appearOptions = { threshold: 0.2, rootMargin: "0px 0px -50px 0px" };
  const appearOnScroll = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('is-visible');
        observer.unobserve(entry.target);
      }
    });
  }, appearOptions);
  faders.forEach(fader => appearOnScroll.observe(fader));
};

const createIconButton = ({ id, ariaLabel, lightSvg, darkSvg }) => {
  const button = document.createElement('button');
  button.id = id;
  button.setAttribute('aria-label', ariaLabel);
  button.className = "p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors";
  button.innerHTML = `${lightSvg}${darkSvg}`;
  return button;
};

const createProductSkeleton = () => {
  const skeleton = document.createElement('div');
  skeleton.className = 'skeleton-card';
  skeleton.innerHTML = `
    <div class="skeleton-img"></div>
    <div class="p-5">
      <div class="skeleton-text w-3/4"></div>
      <div class="skeleton-text w-1/2"></div>
      <div class="mt-4 flex justify-between items-center">
        <div class="skeleton-text w-1/4 h-8"></div>
        <div class="skeleton-text w-1/3 h-10"></div>
      </div>
    </div>
    `;
  return skeleton;
};

const createProductCard = (product) => {
  const card = document.createElement('div');
  card.className = "bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden group transition-all duration-300 ease-in-out hover:shadow-xl hover:shadow-primary-300/20 dark:hover:shadow-primary-500/10 hover:!transform hover:-translate-y-2 flex flex-col cursor-pointer";
  card.dataset.action = 'view-details';
  card.dataset.id = product.id;

  let actionArea;
  if (product.sellerId === currentUser?.uid && (product.status === 'available' || product.status === 'pending')) {
    actionArea = `
      <div class="flex items-center space-x-2">
        <span class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-medium rounded-full">Your Listing</span>
        <button class="delete-product-btn p-2 text-gray-400 hover:text-red-500 rounded-full" data-id="${product.id}" aria-label="Delete item">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
        </button>
      </div>`;
  } else if (product.status === 'available') {
    actionArea = `<button class="add-to-cart-btn animated-btn px-4 py-2 bg-primary-600 text-white text-sm font-semibold rounded-lg" data-id="${product.id}">Add to Cart</button>`;
  }

  let statusBadge = '';
  if (product.status === 'sold') {
    statusBadge = '<div class="absolute top-2 right-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full z-10">SOLD</div>';
  } else if (product.status === 'traded') {
    statusBadge = '<div class="absolute top-2 right-2 bg-purple-500 text-white text-xs font-bold px-2 py-1 rounded-full z-10">TRADED</div>';
  }

  const tradeableBadge = product.isTradeable ? `<div class="absolute top-2 left-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full z-10 flex items-center gap-1">ðŸ”„ Tradeable</div>` : '';

  card.innerHTML = `
    <div class="relative overflow-hidden pointer-events-none">
      ${statusBadge}
      ${tradeableBadge}
      <img src="${product.imageUrl || 'https://placehold.co/400x300/E0F2F7/000000?text=No+Image'}" alt="${product.name}" class="w-full h-52 object-cover transition-transform duration-300 ease-in-out group-hover:scale-105 ${product.status !== 'available' ? 'grayscale' : ''}">
    </div>
    <div class="p-5 flex flex-col flex-grow pointer-events-none">
      <h3 class="text-lg font-bold text-gray-900 dark:text-white mt-1 truncate">${product.name}</h3>
      <p class="text-xs text-gray-500 dark:text-gray-400">Listed by ${product.sellerName || 'a user'}</p>
      <p class="text-gray-600 dark:text-gray-300 text-sm mt-2 flex-grow truncate">${product.description}</p>
      <div class="mt-4 flex justify-between items-center">
        <span class="text-2xl font-bold text-gray-900 dark:text-white font-lexend">â‚¹${product.price?.toFixed(0) || 'N/A'}</span>
        <div class="pointer-events-auto">
          ${actionArea || ''}
        </div>
      </div>
    </div>
    `;
  return card;
};

const renderAuthModal = (view = 'signin') => {
  if (emailVerificationInterval) clearInterval(emailVerificationInterval);

  const passwordInputHTML = `
    <div class="relative">
      <input type="password" id="${view}-password" placeholder="Password${view === 'signup' ? ' (min. 6 characters)' : ''}" class="w-full p-3 border dark:border-gray-600 rounded-lg bg-transparent focus:ring-2 focus:ring-primary-500" required>
      <button type="button" class="password-toggle absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-600 dark:hover:text-gray-300" aria-label="Toggle password visibility">
        <svg class="h-5 w-5 eye-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
        <svg class="h-5 w-5 eye-slash-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z" clip-rule="evenodd" /><path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.742L2.293 6.546A10.005 10.005 0 01.458 10c1.274 4.057 5.022 7 9.542 7 1.126 0 2.206-.23 3.23-.65l-1.568-1.568z" clip-rule="evenodd" /></svg>
      </button>
    </div>`;

  let content = `
    <h2 class="text-3xl font-bold text-center text-gray-800 dark:text-white mb-2">${view === 'signin' ? 'Welcome Back!' : 'Create an Account'}</h2>
    <p class="text-center text-gray-500 dark:text-gray-400 mb-6">${view === 'signin' ? 'Sign in to access the marketplace.' : 'Join your fellow students! ðŸ‘‹'}</p>
    <form id="${view}-form" class="space-y-4" novalidate>
      ${view === 'signup' ? '<div><input type="text" id="signup-name" placeholder="Full Name" class="w-full p-3 border dark:border-gray-600 rounded-lg bg-transparent focus:ring-2 focus:ring-primary-500" required></div>' : ''}
      <div><input type="email" id="${view}-email" placeholder="Email Address" class="w-full p-3 border dark:border-gray-600 rounded-lg bg-transparent focus:ring-2 focus:ring-primary-500" required></div>
      <div>${passwordInputHTML}</div>
      <button type="submit" class="animated-btn w-full p-3 bg-primary-600 text-white rounded-lg font-semibold hover:bg-primary-700">${view === 'signin' ? 'Sign In' : 'Create Account'}</button>
    </form>
    <p class="text-center text-sm text-gray-500 dark:text-gray-400 mt-6">
      ${view === 'signin'
      ? `Don't have an account? <button id="show-signup" class="font-semibold text-primary-600 dark:text-primary-400 hover:underline">Sign Up</button>`
      : `Already have an account? <button id="show-signin" class="font-semibold text-primary-600 dark:text-primary-400 hover:underline">Sign In</button>`
      }
    </p>`;
  if (view === 'verify') {
    content = `<div class="text-center">
      <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 dark:bg-green-900 mb-4">
        <svg class="h-10 w-10 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Verify Your Email</h2>
      <p class="text-gray-600 dark:text-gray-300 mt-2 mb-4">We've sent a verification link to your email. Please check your inbox (and spam folder) to activate your account.</p>
      <p class="text-sm text-gray-500 mb-6">This page will automatically refresh once you're verified.</p>
      <div class="space-y-3">
        <button id="resend-verification-btn" class="animated-btn w-full p-3 bg-primary-600 text-white rounded-lg font-semibold hover:bg-primary-700">Resend Verification Email</button>
        <button id="show-signin" class="animated-btn w-full p-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-600">Back to Sign In</button>
      </div>
      </div>`;
    emailVerificationInterval = setInterval(async () => {
      if (auth.currentUser) {
        await auth.currentUser.reload();
        if (auth.currentUser.emailVerified) {
          clearInterval(emailVerificationInterval);
          showMessage('Email verified successfully! Welcome!', 'success');
          setTimeout(() => window.location.reload(), 2000);
        }
      }
    }, 3000);
  }
  authModalContent.innerHTML = content;
  authModalContent.querySelector('input:not([type=hidden])')?.focus();
};

const renderHeaderActions = () => {
  headerActionsContainer.innerHTML = '';
  if (currentUser) {
    const cartItemCount = Object.keys(cart).length;
    const profileIcon = currentUser.photoURL
      ? `<img src="${currentUser.photoURL}" class="h-10 w-10 rounded-full object-cover">`
      : `<div class="h-10 w-10 bg-primary-100 dark:bg-primary-800 rounded-full flex items-center justify-center font-bold text-primary-600 dark:text-primary-200">${getInitials(currentUser.displayName)}</div>`;

    const themeBtn = createIconButton({
      id: 'theme-toggle-btn',
      ariaLabel: 'Toggle theme',
      lightSvg: `<svg class="w-6 h-6 dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`,
      darkSvg: `<svg class="w-6 h-6 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`,
    });
    themeBtn.classList.add('animate-subtle-pop');
    themeBtn.style.animationDelay = '0ms';

    headerActionsContainer.append(themeBtn);
    headerActionsContainer.insertAdjacentHTML('beforeend', `
      <button id="cart-btn" aria-label="Open shopping cart" class="relative p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors animate-subtle-pop" style="animation-delay: 100ms;">
        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
        ${cartItemCount > 0 ? `<span class="absolute -top-1 -right-1 block h-5 w-5 rounded-full bg-primary-600 text-white text-xs flex items-center justify-center animate-pulse">${cartItemCount}</span>` : ''}
      </button>
      <button data-tab="profile" class="ring-offset-2 dark:ring-offset-gray-800 ring-primary-500 transition-all duration-200 hover:scale-110 rounded-full animate-subtle-pop" style="animation-delay: 200ms;">
        ${profileIcon}
      </button>
      <button id="sign-out-btn" class="hidden sm:block px-4 py-2 bg-gray-200 dark:bg-gray-700 text-sm font-semibold rounded-lg animated-btn hover:bg-gray-300 dark:hover:bg-gray-600 animate-subtle-pop" style="animation-delay: 300ms;">Sign Out</button>
      `);
  } else {
    const themeBtn = createIconButton({
      id: 'theme-toggle-btn', ariaLabel: 'Toggle theme',
      lightSvg: `<svg class="w-6 h-6 dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`,
      darkSvg: `<svg class="w-6 h-6 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`,
    });
    themeBtn.classList.add('animate-subtle-pop');
    headerActionsContainer.append(themeBtn);
    headerActionsContainer.insertAdjacentHTML('beforeend', `<button id="sign-in-btn" class="px-4 py-2 bg-primary-600 text-white text-sm font-semibold rounded-lg animated-btn animate-subtle-pop" style="animation-delay: 100ms;">Sign In</button>`);
  }
};

const renderCart = () => {
  const cartItems = Object.values(cart);
  const total = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const itemsHtml = cartItems.length > 0 ? cartItems.map(item => `
    <div class="flex items-center space-x-4 py-3 border-b border-gray-100 dark:border-gray-700">
      <img src="${item.imageUrl}" class="w-16 h-16 object-cover rounded-md">
      <div class="flex-grow">
        <p class="font-semibold">${item.name}</p>
        <p class="text-sm text-gray-500 dark:text-gray-400">â‚¹${item.price.toFixed(0)}</p>
      </div>
      <button class="remove-from-cart-btn p-1 text-gray-400 hover:text-red-500 rounded-full transition-colors" data-id="${item.id}" aria-label="Remove ${item.name} from cart">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
      </button>
    </div>`).join('') : `<p class="text-center text-gray-500 py-10">Your cart is empty. ðŸ›’</p>`;

  cartDrawer.innerHTML = `
    <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
      <h2 class="text-2xl font-bold">Your Cart</h2>
      <button id="close-cart-btn" aria-label="Close cart drawer" class="p-2 text-2xl hover:text-red-500 transition-colors">&times;</button>
    </div>
    <div class="flex-grow p-6 overflow-y-auto">${itemsHtml}</div>
    <div class="p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
      <div class="flex justify-between items-center mb-4">
        <span class="text-lg font-semibold">Total:</span>
        <span class="text-2xl font-bold">â‚¹${total.toFixed(0)}</span>
      </div>
      <button id="checkout-btn" class="animated-btn w-full p-3 bg-primary-600 text-white rounded-lg font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed" ${cartItems.length === 0 ? 'disabled' : ''}>Proceed to Checkout</button>
    </div>`;
  renderHeaderActions();
};

const renderCheckoutModal = () => {
  const total = Object.values(cart).reduce((sum, item) => sum + (item.price * item.quantity), 0);
  checkoutModalContent.innerHTML = `
    <div class="p-2 sm:p-6">
      <h2 class="text-2xl font-bold text-center mb-2">Complete Your Order</h2>
      <p class="text-center text-gray-500 dark:text-gray-400 mb-6">Total Amount: <span class="font-bold text-primary-600 dark:text-primary-400">â‚¹${total.toFixed(0)}</span></p>
      <form id="checkout-form" class="space-y-4">
        <div><label class="font-semibold text-sm">Pay with UPI</label><input type="text" placeholder="yourname@upi" class="w-full mt-1 p-3 border dark:border-gray-600 rounded-lg bg-transparent"></div>
        <div class="text-center my-2 text-gray-500 text-sm">OR</div>
        <div><label class="font-semibold text-sm">Pay with Card</label><input type="text" placeholder="Card Number" class="w-full mt-1 p-3 border dark:border-gray-600 rounded-lg bg-transparent"></div>
      </form>
      <p class="text-xs text-center text-gray-400 mt-6">This is a simulated payment. No real transaction will occur.</p>
      <div class="flex justify-end space-x-3 mt-6">
        <button id="cancel-checkout-btn" class="px-5 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg font-semibold animated-btn">Cancel</button>
        <button id="confirm-payment-btn" class="px-5 py-2 bg-primary-600 text-white rounded-lg font-semibold animated-btn flex items-center justify-center min-w-[100px]">Pay Now</button>
      </div>
    </div>`;
  checkoutModal.classList.add('show');
  checkoutModalContent.querySelector('input')?.focus();
};

const renderHomePage = () => {
  const homeTab = document.getElementById('home-tab');
  homeTab.innerHTML = `
    <div class="relative bg-primary-700 text-white overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-br from-primary-600 to-primary-800 opacity-80"></div>
      <div class="absolute inset-0">
        <img src="https://images.unsplash.com/photo-1523240795612-9a054b0db644?ixlib=rb-4.0.3&auto=format&fit=crop&w=1740&q=80" class="w-full h-full object-cover opacity-10">
      </div>
      <div class="relative container mx-auto px-6 py-24 md:py-32 text-center">
        <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight">The Student Mart</h1>
        <p class="mt-6 max-w-2xl mx-auto text-lg md:text-xl text-primary-100">Buy, sell, and trade with fellow students. Secure, simple, and built for you.</p>
        <div class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
          <button data-tab="buy" class="animated-btn bg-white text-primary-600 font-bold py-3 px-8 rounded-lg w-full sm:w-auto">Browse Items</button>
          <button data-tab="sell" class="animated-btn bg-primary-500 hover:bg-primary-400 font-bold py-3 px-8 rounded-lg w-full sm:w-auto">Start Selling</button>
        </div>
      </div>
    </div>
    <section class="py-16 sm:py-24 bg-white dark:bg-gray-800/50 fade-in-section">
      <div class="container mx-auto px-6">
        <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white mb-16">How It Works</h2>
        <div class="grid md:grid-cols-3 gap-8 text-center group">
          <div class="p-4"><div class="text-6xl mb-4 how-it-works-icon">âœï¸</div><h3 class="text-xl font-semibold mb-2 dark:text-white">1. Create an Account</h3><p class="text-gray-600 dark:text-gray-300">Quickly sign up with your student email to get started.</p></div>
          <div class="p-4"><div class="text-6xl mb-4 how-it-works-icon">ðŸ”</div><h3 class="text-xl font-semibold mb-2 dark:text-white">2. Browse or List</h3><p class="text-gray-600 dark:text-gray-300">Find what you need or easily list items you want to sell.</p></div>
          <div class="p-4"><div class="text-6xl mb-4 how-it-works-icon">ðŸ¤</div><h3 class="text-xl font-semibold mb-2 dark:text-white">3. Connect & Exchange</h3><p class="text-gray-600 dark:text-gray-300">Connect with other students on campus to complete the exchange.</p></div>
        </div>
      </div>
    </section>

    <section class="py-16 sm:py-24 fade-in-section">
        <div class="container mx-auto px-6">
            <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white mb-16">Why Choose CampusMart?</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 text-center">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <div class="text-4xl mb-4 text-primary-500">ðŸ›¡ï¸</div>
                    <h3 class="text-xl font-semibold mb-2 dark:text-white">Trusted Community</h3>
                    <p class="text-gray-600 dark:text-gray-300">An exclusive marketplace for verified students, ensuring safer and more reliable transactions.</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <div class="text-4xl mb-4 text-primary-500">ðŸ“</div>
                    <h3 class="text-xl font-semibold mb-2 dark:text-white">On-Campus Convenience</h3>
                    <p class="text-gray-600 dark:text-gray-300">No shipping, no hassle. Easily meet up with buyers and sellers right on campus.</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <div class="text-4xl mb-4 text-primary-500">ðŸ’°</div>
                    <h3 class="text-xl font-semibold mb-2 dark:text-white">Budget-Friendly</h3>
                    <p class="text-gray-600 dark:text-gray-300">Find great deals on textbooks, electronics, and more, or make extra cash by selling what you don't need.</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <div class="text-4xl mb-4 text-primary-500">â™»ï¸</div>
                    <h3 class="text-xl font-semibold mb-2 dark:text-white">Eco-Friendly</h3>
                    <p class="text-gray-600 dark:text-gray-300">Promote sustainability by giving pre-loved items a new home and reducing waste.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="py-16 sm:py-24 bg-white dark:bg-gray-800/50 fade-in-section">
      <div class="container mx-auto px-6">
        <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white mb-16">Browse By Category</h2>
        <div id="homepage-categories-container" class="grid grid-cols-2 sm:grid-cols-3 gap-6 text-center"></div>
      </div>
    </section>
    <section class="py-16 sm:py-24 fade-in-section">
      <div class="container mx-auto px-6">
        <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white mb-16">Recently Added Items</h2>
        <div id="recently-added-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8"></div>
      </div>
    </section>
    <section class="py-16 sm:py-24 bg-white dark:bg-gray-800/50 fade-in-section">
      <div class="container mx-auto px-6">
        <div class="flex justify-between items-center mb-8">
          <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Latest Lost & Found</h2>
          <button data-tab="lost-and-found" class="font-semibold text-primary-600 dark:text-primary-400 hover:underline">View All</button>
        </div>
        <div id="homepage-lost-and-found-container" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
      </div>
    </section>

    <section class="py-16 sm:py-24 fade-in-section">
        <div class="container mx-auto px-6 max-w-4xl">
            <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white mb-12">Frequently Asked Questions</h2>
            <div class="space-y-4">
                <details class="group p-4 rounded-lg bg-gray-50 dark:bg-gray-800">
                    <summary class="flex items-center justify-between cursor-pointer font-semibold text-gray-800 dark:text-white group-open:text-primary-600">
                        What is CampusMart?
                        <svg class="w-5 h-5 transform group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <p class="mt-3 text-gray-600 dark:text-gray-300">CampusMart is a dedicated online marketplace created exclusively for students. Our mission is to provide a safe, convenient, and affordable way for you to buy, sell, and trade goods like textbooks, electronics, and furniture directly with other students on your campus.</p>
                </details>
                <details class="group p-4 rounded-lg bg-gray-50 dark:bg-gray-800">
                    <summary class="flex items-center justify-between cursor-pointer font-semibold text-gray-800 dark:text-white group-open:text-primary-600">
                        How do I get paid when I sell an item?
                        <svg class="w-5 h-5 transform group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <p class="mt-3 text-gray-600 dark:text-gray-300">This platform facilitates the connection between students. All payments (cash, UPI, etc.) are handled directly between the buyer and seller during your in-person meetup on campus.</p>
                </details>
                <details class="group p-4 rounded-lg bg-gray-50 dark:bg-gray-800">
                    <summary class="flex items-center justify-between cursor-pointer font-semibold text-gray-800 dark:text-white group-open:text-primary-600">
                        Is it safe to meet with buyers/sellers?
                        <svg class="w-5 h-5 transform group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <p class="mt-3 text-gray-600 dark:text-gray-300">We strongly recommend meeting in well-lit, public places on campus, such as the library lobby, student union, or a busy cafe. Always inform a friend about your meeting details for extra safety.</p>
                </details>
                <details class="group p-4 rounded-lg bg-gray-50 dark:bg-gray-800">
                    <summary class="flex items-center justify-between cursor-pointer font-semibold text-gray-800 dark:text-white group-open:text-primary-600">
                        Can I trade items instead of just buying/selling?
                        <svg class="w-5 h-5 transform group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <p class="mt-3 text-gray-600 dark:text-gray-300">Yes! Sellers can mark their items as "Tradeable." You can browse these items on the 'Trade/Barter' tab and make offers to swap your items instead of paying cash.</p>
                </details>
            </div>
        </div>
    </section>
  `;
  renderHomepageCategories();
  renderRecentlyAddedProducts();
  renderHomepageLostAndFoundPreview();
  setupScrollAnimations();
};

const renderBuyPage = () => {
  const container = document.getElementById('buy-tab');
  container.innerHTML = `
    ${getBackButtonHTML('Back')}
    <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-6">Available Items</h2>
    <div id="filter-controls" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md mb-8 flex flex-col md:flex-row gap-4 items-center flex-wrap">
      <div class="relative flex-grow w-full md:w-auto">
        <label for="search-input" class="sr-only">Search</label>
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
        <input type="search" id="search-input" placeholder="Search for items..." class="w-full p-2 pl-10 border dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
      </div>
      <div class="flex-1 w-full md:w-auto">
        <label for="filter-category" class="sr-only">Category</label>
        <select id="filter-category" class="w-full p-2 border dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200">
          <option value="all">All Categories</option>
          <option value="Books">Books</option>
          <option value="Electronics">Electronics</option>
          <option value="Furniture">Furniture</option>
          <option value="Clothing">Clothing</option>
          <option value="Stationery">Stationery</option>
          <option value="Sports Gear">Sports Gear</option>
          <option value="Services">Services</option>
          <option value="Tickets">Event Tickets</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="flex-1 w-full md:w-auto">
        <label for="filter-price" class="sr-only">Price</label>
        <select id="filter-price" class="w-full p-2 border dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200">
          <option value="all">All Prices</option>
          <option value="0-500">Under â‚¹500</option>
          <option value="500-2000">â‚¹500 - â‚¹2000</option>
          <option value="2000-5000">â‚¹2000 - â‚¹5000</option>
          <option value="5000-9999999">Over â‚¹5000</option>
        </select>
      </div>
      <div class="flex-1 w-full md:w-auto">
        <label for="filter-sort" class="sr-only">Sort By</label>
        <select id="filter-sort" class="w-full p-2 border dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200">
          <option value="newest">Sort: Newest</option>
          <option value="price-asc">Sort: Price Low-High</option>
          <option value="price-desc">Sort: Price High-Low</option>
        </select>
      </div>
      <button id="reset-filters" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg font-semibold h-10 w-full md:w-auto">Reset</button>
    </div>
    <div id="product-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
    `;
  filterAndRenderProducts(false);

  const searchInput = container.querySelector('#search-input');
  const categoryInput = container.querySelector('#filter-category');
  const priceInput = container.querySelector('#filter-price');
  const sortInput = container.querySelector('#filter-sort');
  const resetBtn = container.querySelector('#reset-filters');

  searchInput.addEventListener('input', () => filterAndRenderProducts(false));
  categoryInput.addEventListener('change', () => filterAndRenderProducts(false));
  priceInput.addEventListener('change', () => filterAndRenderProducts(false));
  sortInput.addEventListener('change', () => filterAndRenderProducts(false));
  resetBtn.addEventListener('click', () => {
    searchInput.value = '';
    categoryInput.value = 'all';
    priceInput.value = 'all';
    sortInput.value = 'newest';
    filterAndRenderProducts(false);
  });
};

const renderTradePage = () => {
  const container = document.getElementById('trade-tab');
  container.innerHTML = `
    ${getBackButtonHTML('Back')}
    <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-6">Items Available for Trade/Barter</h2>
    <div id="filter-controls" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md mb-8 flex flex-col md:flex-row gap-4 items-center flex-wrap">
      <div class="relative flex-grow w-full md:w-auto">
        <label for="search-input" class="sr-only">Search</label>
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
        <input type="search" id="search-input" placeholder="Search for items..." class="w-full p-2 pl-10 border dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
      </div>
      <div class="flex-1 w-full md:w-auto">
        <label for="filter-category" class="sr-only">Category</label>
        <select id="filter-category" class="w-full p-2 border dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200">
          <option value="all">All Categories</option>
          <option value="Books">Books</option>
          <option value="Electronics">Electronics</option>
          <option value="Furniture">Furniture</option>
          <option value="Clothing">Clothing</option>
          <option value="Stationery">Stationery</option>
          <option value="Sports Gear">Sports Gear</option>
          <option value="Services">Services</option>
          <option value="Tickets">Event Tickets</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="flex-1 w-full md:w-auto">
        <label for="filter-price" class="sr-only">Price</label>
        <select id="filter-price" class="w-full p-2 border dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200">
          <option value="all">All Prices</option>
          <option value="0-500">Under â‚¹500</option>
          <option value="500-2000">â‚¹500 - â‚¹2000</option>
          <option value="2000-5000">â‚¹2000 - â‚¹5000</option>
          <option value="5000-9999999">Over â‚¹5000</option>
        </select>
      </div>
      <div class="flex-1 w-full md:w-auto">
        <label for="filter-sort" class="sr-only">Sort By</label>
        <select id="filter-sort" class="w-full p-2 border dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200">
          <option value="newest">Sort: Newest</option>
          <option value="price-asc">Sort: Price Low-High</option>
          <option value="price-desc">Sort: Price High-Low</option>
        </select>
      </div>
      <button id="reset-filters" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg font-semibold h-10 w-full md:w-auto">Reset</button>
    </div>
    <div id="trade-product-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
    `;
  filterAndRenderProducts(true);

  const searchInput = container.querySelector('#search-input');
  const categoryInput = container.querySelector('#filter-category');
  const priceInput = container.querySelector('#filter-price');
  const sortInput = container.querySelector('#filter-sort');
  const resetBtn = container.querySelector('#reset-filters');

  searchInput.addEventListener('input', () => filterAndRenderProducts(true));
  categoryInput.addEventListener('change', () => filterAndRenderProducts(true));
  priceInput.addEventListener('change', () => filterAndRenderProducts(true));
  sortInput.addEventListener('change', () => filterAndRenderProducts(true));
  resetBtn.addEventListener('click', () => {
    searchInput.value = '';
    categoryInput.value = 'all';
    priceInput.value = 'all';
    sortInput.value = 'newest';
    filterAndRenderProducts(true);
  });
};

const filterAndRenderProducts = (tradeOnly = false) => {
  const tabId = tradeOnly ? 'trade-tab' : 'buy-tab';
  const search = document.querySelector(`#${tabId} #search-input`)?.value.toLowerCase() || '';
  const category = document.querySelector(`#${tabId} #filter-category`)?.value || 'all';
  const price = document.querySelector(`#${tabId} #filter-price`)?.value || 'all';
  const sort = document.querySelector(`#${tabId} #filter-sort`)?.value || 'newest';

  let productsToRender = [...products.filter(p => p.status === 'available')];

  if (tradeOnly) {
    productsToRender = productsToRender.filter(p => p.isTradeable);
  }

  if (search) {
    productsToRender = productsToRender.filter(p => p.name.toLowerCase().includes(search));
  }

  if (category !== 'all') {
    productsToRender = productsToRender.filter(p => p.category === category);
  }

  if (price !== 'all') {
    const [min, max] = price.split('-').map(Number);
    productsToRender = productsToRender.filter(p => p.price >= min && p.price <= max);
  }

  if (sort === 'price-asc') {
    productsToRender.sort((a, b) => a.price - b.price);
  } else if (sort === 'price-desc') {
    productsToRender.sort((a, b) => b.price - a.price);
  } else {
    productsToRender.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
  }

  renderProductList(productsToRender, tradeOnly);
};

const renderProductList = (productsToRender, tradeOnly = false) => {
  const containerId = tradeOnly ? 'trade-product-list-container' : 'product-list-container';
  const container = document.getElementById(containerId);
  if (!container) return;

  container.innerHTML = '';

  if (productsToRender.length > 0) {
    productsToRender.forEach(p => container.appendChild(createProductCard(p)));
  } else {
    const message = tradeOnly ? 'No items are currently available for trade.' : 'No products match your search. ðŸ¤·';
    if (currentUser) {
      container.innerHTML = `<p class="text-gray-500 text-center py-10 col-span-full">${message}</p>`;
    } else {
      for (let i = 0; i < 8; i++) container.appendChild(createProductSkeleton());
    }
  }
};

const renderRecentlyAddedProducts = () => {
  const container = document.getElementById('recently-added-container');
  if (!container) return;
  container.innerHTML = '';
  const featured = products.filter(p => p.status === 'available').sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)).slice(0, 4);
  if (featured.length > 0) {
    featured.forEach(p => container.appendChild(createProductCard(p)));
  } else {
    container.innerHTML = `<p class="text-gray-500 text-center py-10 col-span-full">No items have been added yet. Be the first!</p>`;
  }
};

const renderHomepageCategories = () => {
  const container = document.getElementById('homepage-categories-container');
  if (!container) return;
  const categories = [
    { name: 'Books', icon: 'ðŸ“š', value: 'Books' },
    { name: 'Electronics', icon: 'ðŸ’»', value: 'Electronics' },
    { name: 'Furniture', icon: 'ðŸ›‹ï¸', value: 'Furniture' },
    { name: 'Clothing', icon: 'ðŸ‘•', value: 'Clothing' },
    { name: 'Stationery', icon: 'âœï¸', value: 'Stationery' },
    { name: 'Sports Gear', icon: 'âš½', value: 'Sports Gear' },
    { name: 'Services', icon: 'ðŸ¤', value: 'Services' },
    { name: 'Event Tickets', icon: 'ðŸŽŸï¸', value: 'Tickets' },
    { name: 'Other', icon: 'ðŸ“¦', value: 'Other' },
  ];
  container.innerHTML = categories.map(cat => `
    <div class="category-card p-4 bg-white dark:bg-gray-800 rounded-xl shadow-md group" data-category="${cat.value}">
      <div class="text-5xl mb-3 category-card-icon">${cat.icon}</div>
      <h3 class="font-semibold text-gray-800 dark:text-white">${cat.name}</h3>
    </div>
    `).join('');
};

const renderHomepageLostAndFoundPreview = () => {
  const container = document.getElementById('homepage-lost-and-found-container');
  if (!container) return;
  const latestItems = lostAndFoundItems.slice(0, 3);
  if (latestItems.length === 0) {
    container.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center col-span-full py-8">Nothing lost, nothing found. All is well!</p>`;
    return;
  }
  container.innerHTML = latestItems.map(item => {
    const isLost = item.reportType === 'lost';
    const badgeColor = isLost ? 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300' : 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300';
    const badgeText = isLost ? 'LOST' : 'FOUND';
    return `
      <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg flex items-center gap-4">
        <img src="${item.imageUrl || 'https://placehold.co/400x300/E0F2F7/777777?text=No+Image'}" alt="${item.title}" class="w-20 h-20 object-cover rounded-lg flex-shrink-0">
        <div class="flex-grow">
          <span class="text-xs font-bold px-2 py-0.5 rounded-full ${badgeColor}">${badgeText}</span>
          <h4 class="font-bold text-gray-800 dark:text-white mt-1 truncate">${item.title}</h4>
          <p class="text-sm text-gray-500 dark:text-gray-400 truncate">${isLost ? 'Last seen:' : 'Found at:'} ${item.location}</p>
        </div>
      </div>
      `;
  }).join('');
};

const renderProductDetailPage = (product) => {
  const container = document.getElementById('product-detail-tab');
  if (!container) return;

  if (offersUnsubscribe) offersUnsubscribe();

  const images = [product.imageUrl];
  if (!images[0]) images[0] = 'https://placehold.co/800x600/E0F2F7/000000?text=No+Image';

  let actionButtonHTML = '';
  const isMyProduct = currentUser?.uid === product.sellerId;

  if (product.status === 'sold' || product.status === 'traded') {
    const statusText = product.status === 'sold' ? 'Item Sold' : 'Item Traded';
    const bgColor = product.status === 'sold' ? 'bg-red-500' : 'bg-purple-500';
    actionButtonHTML = `<button class="px-6 py-3 ${bgColor} text-white text-base font-semibold rounded-lg w-full sm:w-auto cursor-not-allowed" disabled>${statusText}</button>`;
  } else if (!isMyProduct) {
    actionButtonHTML = `<button class="add-to-cart-btn animated-btn px-6 py-3 bg-primary-600 text-white text-base font-semibold rounded-lg w-full" data-id="${product.id}">Add to Cart</button>`;
    if (product.isTradeable) {
      actionButtonHTML += `<button class="make-trade-offer-btn animated-btn px-6 py-3 bg-green-600 text-white text-base font-semibold rounded-lg w-full mt-2" data-product-id="${product.id}">Make a Trade Offer</button>`;
    }
  }

  const statusBadge = product.status === 'sold' ? `<span class="absolute top-4 right-4 bg-red-500 text-white text-sm font-bold px-3 py-1 rounded-full z-10">SOLD</span>`
    : product.status === 'traded' ? `<span class="absolute top-4 right-4 bg-purple-500 text-white text-sm font-bold px-3 py-1 rounded-full z-10">TRADED</span>`
    : '';

  const tradeableBadge = product.isTradeable ? `<div class="absolute top-4 left-4 bg-green-500 text-white text-sm font-bold px-3 py-1 rounded-full z-10 flex items-center gap-1">ðŸ”„ Tradeable</div>` : '';

  const offersSectionHTML = (isMyProduct && product.isTradeable && product.status === 'available') ? `<div id="offers-section" class="mt-8"></div>` : '';

  container.innerHTML = `
    <div class="container mx-auto p-4 sm:p-6">
      ${getBackButtonHTML('Back to Listings')}
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
        <div class="grid md:grid-cols-2">
          <div class="p-4">
            <div id="image-carousel" class="relative group">
              ${statusBadge}
              ${tradeableBadge}
              <img id="main-product-image" src="${images[0]}" alt="${product.name}" class="w-full h-[500px] object-contain rounded-lg ${product.status !== 'available' ? 'grayscale' : ''}">
            </div>
          </div>
          <div class="p-8 flex flex-col">
            <h1 class="text-3xl lg:text-4xl font-bold font-lexend text-gray-900 dark:text-white">${product.name}</h1>
            <div class="mt-4 py-4 border-y border-gray-100 dark:border-gray-700 flex items-center gap-4">
              <img src="${product.sellerPhotoURL || `https://placehold.co/48x48/dbeafe/1e40af?text=${getInitials(product.sellerName)}`}" alt="${product.sellerName}" class="w-12 h-12 rounded-full object-cover bg-primary-100">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Listed by</p>
                <p class="font-semibold text-gray-800 dark:text-white text-lg">${product.sellerName}</p>
              </div>
            </div>
            <p class="text-gray-600 dark:text-gray-300 mt-6 flex-grow text-base">${product.description}</p>
            <div class="mt-8">
              <p class="text-sm text-gray-400">PRICE</p>
              <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <span class="text-4xl font-bold text-gray-900 dark:text-white font-lexend">â‚¹${product.price.toFixed(0)}</span>
                <div class="w-full sm:w-auto">${actionButtonHTML}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      ${offersSectionHTML}
    </div>
    `;

  if (isMyProduct && product.isTradeable && product.status === 'available') {
    renderSellerOffersView(product.id);
  }
};

const renderSellPage = () => {
  const container = document.getElementById('sell-tab');
  uploadedProductFile = null;
  container.innerHTML = `
    <div class="w-full max-w-2xl mx-auto">
        ${getBackButtonHTML('Back')}
    </div>
    <div class="flex flex-col justify-center items-center min-h-[calc(100vh-280px)] py-8">
      <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-8">List a New Item</h2>
      <form id="add-product-form" class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg space-y-4 w-full max-w-2xl mx-auto" novalidate>
        <div>
          <label for="image-drop-zone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Product Image</label>
          <div id="image-drop-zone" class="flex justify-center items-center w-full h-64 rounded-lg bg-gray-50 dark:bg-gray-700 cursor-pointer">
            <div id="image-upload-prompt" class="text-center text-gray-500 dark:text-gray-400">
              <svg class="mx-auto h-12 w-12" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
              <p class="mt-2">Drag & drop image, or <span class="font-semibold text-primary-600 dark:text-primary-400">click to upload</span></p>
              <input type="file" id="imageUrlUpload" class="hidden" accept="image/*">
            </div>
            <img id="image-preview" class="hidden w-full h-full object-contain rounded-lg p-2">
          </div>
        </div>
        <div>
          <input type="text" id="productName" placeholder="Product Name" class="w-full p-3 border dark:border-gray-600 rounded-lg bg-transparent" required>
        </div>
        <div>
          <textarea id="description" placeholder="Detailed Description" class="w-full p-3 border dark:border-gray-600 rounded-lg bg-transparent" rows="4" required></textarea>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <input type="number" id="price" placeholder="Price (â‚¹)" class="w-full p-3 border dark:border-gray-600 rounded-lg bg-transparent" required min="0" step="1">
          </div>
          <select id="category" class="w-full p-3 border dark:border-gray-600 rounded-lg bg-transparent dark:bg-gray-700 dark:text-gray-200">
            <option>Books</option>
            <option>Electronics</option>
            <option>Furniture</option>
            <option>Clothing</option>
            <option>Stationery</option>
            <option>Sports Gear</option>
            <option>Services</option>
            <option value="Tickets">Event Tickets</option>
            <option>Other</option>
          </select>
        </div>
        <div class="flex items-center space-x-3 bg-green-50 dark:bg-green-900/20 p-3 rounded-lg">
          <input type="checkbox" id="isTradeable" class="h-4 w-4 rounded text-primary-600 focus:ring-primary-500 border-gray-300 dark:border-gray-600 dark:bg-gray-700">
          <label for="isTradeable" class="text-sm font-medium text-green-800 dark:text-green-200">Accept Trade/Barter Offers for this item</label>
        </div>
        <button type="submit" id="list-item-btn" class="w-full p-3 bg-primary-600 text-white rounded-lg font-semibold flex items-center justify-center animated-btn">List My Item</button>
      </form>
    </div>`;
  setupImageUploadListeners('image-drop-zone', 'imageUrlUpload', 'image-preview', 'image-upload-prompt', file => uploadedProductFile = file);
  document.getElementById('productName').addEventListener('blur', (e) => validateInput(e.target, val => val.trim().length > 2, 'Name must be longer than 2 characters.'));
  document.getElementById('description').addEventListener('blur', (e) => validateInput(e.target, val => val.trim().length > 10, 'Description must be longer than 10 characters.'));
};

const renderLostAndFoundPage = () => {
  const container = document.getElementById('lost-and-found-tab');
  container.innerHTML = `
    ${getBackButtonHTML('Back')}
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
      <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Lost & Found</h2>
      <div class="flex space-x-4">
        <button class="add-lost-found-btn animated-btn bg-red-500 text-white font-semibold py-2 px-5 rounded-lg" data-type="lost">Report a Lost Item</button>
        <button class="add-lost-found-btn animated-btn bg-green-500 text-white font-semibold py-2 px-5 rounded-lg" data-type="found">Report a Found Item</button>
      </div>
    </div>
    <div id="lost-found-filter-controls" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md mb-8 flex flex-col md:flex-row gap-4 items-center">
      <div class="relative flex-grow w-full md:w-auto">
        <label for="lost-found-search-input" class="sr-only">Search</label>
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
        <input type="search" id="lost-found-search-input" placeholder="Search title or description..." class="w-full p-2 pl-10 border dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
      </div>
      <div class="flex-shrink-0">
        <label for="lost-found-filter-status" class="sr-only">Filter by status</label>
        <select id="lost-found-filter-status" class="w-full p-2 border dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200">
          <option value="all">Show All</option>
          <option value="lost">Show Lost Items</option>
          <option value="found">Show Found Items</option>
        </select>
      </div>
    </div>
    <div id="lost-and-found-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
    `;

  filterAndRenderLostFoundItems();

  document.getElementById('lost-found-search-input').addEventListener('input', filterAndRenderLostFoundItems);
  document.getElementById('lost-found-filter-status').addEventListener('change', filterAndRenderLostFoundItems);
};

const filterAndRenderLostFoundItems = () => {
  const container = document.getElementById('lost-and-found-list-container');
  if (!container) return;

  const search = document.getElementById('lost-found-search-input')?.value.toLowerCase() || '';
  const statusFilter = document.getElementById('lost-found-filter-status')?.value || 'all';

  let itemsToRender = [...lostAndFoundItems];

  if (search) {
    itemsToRender = itemsToRender.filter(item =>
      item.title.toLowerCase().includes(search) || item.description.toLowerCase().includes(search)
    );
  }

  if (statusFilter !== 'all') {
    itemsToRender = itemsToRender.filter(item => item.reportType === statusFilter);
  }

  container.innerHTML = '';
  if (itemsToRender.length > 0) {
    itemsToRender.forEach(item => container.appendChild(createLostAndFoundCard(item)));
  } else {
    container.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center py-10 col-span-full">No items found matching your criteria. ðŸ¤·</p>`;
  }
};

const createLostAndFoundCard = (item) => {
    const card = document.createElement('div');
    const isResolved = item.status === 'resolved';
    card.className = `bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden flex flex-col ${isResolved ? 'opacity-60' : ''}`;

    const isLost = item.reportType === 'lost';
    const badgeColor = isLost ? 'bg-red-500' : 'bg-green-500';
    const badgeText = isLost ? 'LOST' : 'FOUND';

    const reportDate = item.createdAt ? new Date(item.createdAt.toDate()).toLocaleDateString() : 'Just now';

    const isMyReport = currentUser?.uid === item.reporterId;

    let actionButtonHTML = '';
    if (isMyReport) {
        // Reporter sees management buttons
        actionButtonHTML = `
            <div class="flex items-center gap-2 mt-4">
                <button class="resolve-lost-found-btn flex-grow animated-btn px-4 py-2 text-sm font-semibold rounded-lg ${isResolved ? 'bg-yellow-500 text-white' : 'bg-blue-500 text-white'}" data-id="${item.id}" data-status="${item.status}">
                    ${isResolved ? 'Mark as Active' : 'Mark as Resolved'}
                </button>
                <button class="delete-lost-found-btn p-2 text-gray-400 hover:text-red-500 rounded-lg bg-gray-100 dark:bg-gray-700" data-id="${item.id}" aria-label="Delete report">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            </div>`;
    } else {
        // Others see the contact button
        const contactSubject = `CampusMart: Inquiry about the ${item.title}`;
        const contactBody = `Hi ${item.reporterName},%0D%0A%0D%0AI saw your listing for the ${item.reportType} item titled "${item.title}". I would like to inquire about it.%0D%0A%0D%0AThanks,`;
        actionButtonHTML = `
            <a href="mailto:${item.reporterEmail}?subject=${contactSubject}&body=${contactBody}" class="contact-lost-found-btn mt-4 inline-block w-full text-center animated-btn px-4 py-2 bg-primary-600 text-white text-sm font-semibold rounded-lg">
                Contact ${isLost ? 'Owner' : 'Finder'}
            </a>`;
    }

    card.innerHTML = `
        <div class="relative">
            <img src="${item.imageUrl || 'https://placehold.co/400x300/E0F2F7/777777?text=No+Image'}" alt="${item.title}" class="w-full h-52 object-cover ${isResolved ? 'grayscale' : ''}">
            <div class="absolute top-2 left-2 ${badgeColor} text-white text-xs font-bold px-2 py-1 rounded-full z-10">${badgeText}</div>
            ${isResolved ? `<div class="absolute top-2 right-2 bg-gray-700 text-white text-xs font-bold px-2 py-1 rounded-full z-10">RESOLVED</div>` : ''}
        </div>
        <div class="p-5 flex flex-col flex-grow">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white truncate">${item.title}</h3>
            <p class="text-xs text-gray-500 dark:text-gray-400">Reported by ${item.reporterName} on ${reportDate}</p>
            <p class="text-gray-600 dark:text-gray-300 text-sm mt-3 flex-grow">${item.description}</p>
            <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700 space-y-2 text-sm">
                <p><strong class="text-gray-500 dark:text-gray-400">${isLost ? 'Last Seen At:' : 'Found At:'}</strong> ${item.location}</p>
                ${!isLost ? `<p><strong class="text-gray-500 dark:text-gray-400">Collection Point:</strong> ${item.collectionPoint}</p>` : ''}
            </div>
            ${actionButtonHTML}
        </div>
        `;
    return card;
};
const handleLostFoundStatusChange = async (itemId, currentStatus) => {
    const newStatus = currentStatus === 'active' ? 'resolved' : 'active';
    try {
        await db.collection('lost_and_found').doc(itemId).update({
            status: newStatus
        });
        showMessage(`Item marked as ${newStatus}.`, 'success');
        // The onSnapshot listener will automatically update the UI.
    } catch (error) {
        console.error("Error updating item status:", error);
        showMessage("Failed to update status. Please try again.", "error");
    }
};

const renderLostAndFoundModal = (reportType = 'lost') => {
  uploadedLostFoundFile = null;
  const isLost = reportType === 'lost';
  lostAndFoundModalContent.innerHTML = `
    <form id="lost-and-found-form" class="p-6 space-y-4" novalidate>
      <h2 class="text-2xl font-bold text-center text-gray-900 dark:text-white mb-4">Report an Item</h2>
      <input type="hidden" id="reportType" value="${reportType}">
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Item Image (Required)</label>
        <div id="lost-found-drop-zone" class="mt-1 flex justify-center items-center w-full h-48 rounded-lg bg-gray-50 dark:bg-gray-700 cursor-pointer">
          <div id="lost-found-upload-prompt" class="text-center text-gray-500 dark:text-gray-400">
            <svg class="mx-auto h-12 w-12" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
            <p class="mt-2 text-sm">Drag & drop or <span class="font-semibold text-primary-600">click to upload</span></p>
            <input type="file" id="lostFoundImageUpload" class="hidden" accept="image/*">
          </div>
          <img id="lost-found-image-preview" class="hidden w-full h-full object-contain rounded-lg p-2">
        </div>
      </div>
      <div><input type="text" id="lostFoundTitle" placeholder="Item Title (e.g., Black Wallet, Blue Water Bottle)" class="w-full p-3 border dark:border-gray-600 rounded-lg bg-transparent" required></div>
      <div><textarea id="lostFoundDescription" placeholder="Detailed Description (e.g., Brand, color, identifying marks)" class="w-full p-3 border dark:border-gray-600 rounded-lg bg-transparent" rows="3" required></textarea></div>
      <div><input type="text" id="lostFoundLocation" placeholder="${isLost ? 'Last Seen Location' : 'Location Where Item Was Found'}" class="w-full p-3 border dark:border-gray-600 rounded-lg bg-transparent" required></div>
      ${!isLost ? `<div><input type="text" id="lostFoundCollectionPoint" placeholder="Where to Collect (e.g., Main Library Front Desk)" class="w-full p-3 border dark:border-gray-600 rounded-lg bg-transparent" required></div>` : ''}
      <div class="flex justify-end space-x-4 pt-4">
        <button type="button" id="cancel-lost-found-btn" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg font-semibold animated-btn">Cancel</button>
        <button type="submit" id="submit-lost-found-btn" class="px-6 py-2 bg-primary-600 text-white rounded-lg font-semibold animated-btn flex items-center justify-center min-w-[120px]">Submit Report</button>
      </div>
    </form>
    `;
  lostAndFoundModal.classList.add('show');
  setupImageUploadListeners('lost-found-drop-zone', 'lostFoundImageUpload', 'lost-found-image-preview', 'lost-found-upload-prompt', file => uploadedLostFoundFile = file);
};

const renderOrdersPage = () => {
    const container = document.getElementById('orders-tab');
    let content = `
        ${getBackButtonHTML('Back')}
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-gray-800 dark:text-white">My Order History</h2>
            ${orders.length > 0 ? `
                <button id="clear-order-history-btn" class="animated-btn px-4 py-2 bg-red-500 hover:bg-red-600 text-white text-sm font-semibold rounded-lg flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    Clear History
                </button>
            ` : ''}
        </div>`;

    if (orders.length === 0) {
        content += `<div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg text-center"><p class="text-gray-500">You haven't placed any orders yet. Time to shop! ðŸ›ï¸</p></div>`;
    } else {
        content += `<div class="space-y-6">${orders.map(order => {
            const orderDate = order.createdAt ? new Date(order.createdAt.toDate()).toLocaleString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }) : 'Just now';
            return `
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-start border-b border-gray-200 dark:border-gray-700 pb-4 mb-4 gap-2">
                    <div>
                        <p class="font-bold text-lg">Order Placed</p>
                        <p class="text-sm text-gray-500">${orderDate}</p>
                    </div>
                    <div class="text-left sm:text-right">
                        <p class="font-semibold text-lg">Total: â‚¹${order.total.toFixed(0)}</p>
                        <p class="text-xs text-gray-500 font-mono">ID: ${order.id}</p>
                    </div>
                </div>
                <div class="space-y-4">
                    ${order.items.map(item => {
                        const fullProduct = products.find(p => p.id === item.productId);
                        const sellerEmail = fullProduct ? fullProduct.sellerEmail : null;
                        return `
                        <div class="flex items-start sm:items-center justify-between gap-4 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors flex-col sm:flex-row">
                            <div class="flex items-center space-x-4 flex-grow cursor-pointer" data-action="view-details" data-id="${item.productId}">
                                <img src="${item.imageUrl}" class="w-16 h-16 object-cover rounded-md flex-shrink-0">
                                <div class="flex-grow">
                                    <p class="font-semibold">${item.name}</p>
                                    <p class="text-gray-500 font-semibold text-sm">â‚¹${item.price.toFixed(0)}</p>
                                </div>
                            </div>
                            <div class="flex-shrink-0 w-full sm:w-auto text-right pl-0 sm:pl-4">
                                ${sellerEmail ?
                                `<a href="mailto:${sellerEmail}?subject=Question about Campus Exchange Order: ${order.id}" class="contact-seller-btn inline-block px-4 py-2 bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 text-sm font-semibold rounded-lg animated-btn">Contact Seller</a>` :
                                `<button class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-500 text-sm font-semibold rounded-lg cursor-not-allowed" disabled>Contact Unavailable</button>`
                                }
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>
            `;
        }).join('')}</div>`;
    }
    container.innerHTML = content;
};
const handleClearOrderHistory = () => {
    if (!currentUser) return;

    showConfirmModal("Are you sure you want to clear your entire order history? This action cannot be undone.", async () => {
        try {
            const batch = db.batch();
            const ordersQuery = db.collection('orders').where('userId', '==', currentUser.uid);
            const snapshot = await ordersQuery.get();

            if (snapshot.empty) {
                showMessage("No orders to clear.", "success");
                return;
            }

            snapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });

            await batch.commit();
            showMessage("Order history has been cleared.", "success");
            // The onSnapshot listener will automatically update the UI
        } catch (error) {
            console.error("Error clearing order history:", error);
            showMessage(`Failed to clear history: ${error.message}`, "error");
        }
    });
};
const renderMyListingsPage = () => {
  const container = document.getElementById('my-listings-tab');
  const myListings = products.filter(p => p.sellerId === currentUser.uid);
  const availableItems = myListings.filter(p => p.status === 'available');
  const soldItems = myListings.filter(p => p.status === 'sold' || p.status === 'traded');

  let content = `
    ${getBackButtonHTML('Back')}
    <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-8">My Listings</h2>`;

  if (myListings.length === 0) {
    content += `<div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg text-center"><p class="text-gray-500">You haven't listed any items for sale yet.</p></div>`;
  } else {
    content += `
      <div>
        <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Items for Sale (${availableItems.length})</h3>
        <div id="available-listings" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
      </div>
      <div class="mt-12">
        <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Sold & Traded Items (${soldItems.length})</h3>
        <div id="sold-listings" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
      </div>
      `;
  }
  container.innerHTML = content;

  const availableContainer = document.getElementById('available-listings');
  if (availableContainer) {
    if (availableItems.length > 0) {
      availableItems.forEach(p => availableContainer.appendChild(createProductCard(p)));
    } else {
      availableContainer.innerHTML = `<p class="text-gray-500 col-span-full">No items currently for sale.</p>`;
    }
  }

  const soldContainer = document.getElementById('sold-listings');
  if (soldContainer) {
    if (soldItems.length > 0) {
      soldItems.forEach(p => soldContainer.appendChild(createProductCard(p)));
    } else {
      soldContainer.innerHTML = `<p class="text-gray-500 col-span-full">No sold or traded items yet.</p>`;
    }
  }
};

const renderProfilePage = () => {
  if (!currentUser) return;
  const container = document.getElementById('profile-tab');

  const profileIcon = currentUser.photoURL
    ? `<img src="${currentUser.photoURL}" class="h-24 w-24 rounded-full object-cover ring-4 ring-primary-300 dark:ring-primary-600">`
    : `<div class="h-24 w-24 bg-primary-100 dark:bg-primary-800 rounded-full flex items-center justify-center font-bold text-4xl text-primary-600 dark:text-primary-200 ring-4 ring-primary-300 dark:ring-primary-600">${getInitials(currentUser.displayName)}</div>`;

  container.innerHTML = `
    <div class="max-w-4xl mx-auto">
        ${getBackButtonHTML('Back')}
        <div class="space-y-8">
            <h2 class="text-3xl font-bold text-gray-800 dark:text-white">My Profile</h2>
            <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-lg flex flex-col sm:flex-row items-center gap-6">
                <div class="relative profile-pic-container">${profileIcon}</div>
                <div class="flex-grow text-center sm:text-left">
                    <h3 class="text-2xl font-bold text-gray-800 dark:text-white">${currentUser.displayName}</h3>
                    <p class="text-gray-500 dark:text-gray-400">${currentUser.email}</p>
                    <button id="change-pic-btn" class="mt-3 animated-btn px-4 py-2 bg-gray-200 dark:bg-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">Change Picture</button>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Account Details</h3>
                <form id="update-profile-form" class="space-y-4" novalidate>
                    <div>
                        <label for="profile-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Full Name</label>
                        <input type="text" id="profile-name" value="${currentUser.displayName || ''}" class="mt-1 w-full p-3 border dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700" required>
                    </div>
                    <div>
                        <label for="profile-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email Address</label>
                        <input type="email" id="profile-email" value="${currentUser.email}" class="mt-1 w-full p-3 border dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-900/50 cursor-not-allowed" disabled>
                    </div>
                    <div class="text-right"><button type="submit" id="update-profile-btn" class="animated-btn px-5 py-2 bg-primary-600 text-white rounded-lg font-semibold">Save Changes</button></div>
                </form>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Security</h3>
                <div class="flex justify-between items-center">
                    <p>Change your password.</p>
                    <button id="change-password-btn" class="animated-btn px-5 py-2 bg-gray-200 dark:bg-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">Change Password</button>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Sign Out</h3>
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <p class="text-gray-600 dark:text-gray-400">Are you sure you want to sign out of your account?</p>
                    <button id="sign-out-btn" class="animated-btn w-full sm:w-auto px-5 py-2 bg-red-500 text-white text-sm font-semibold rounded-lg hover:bg-red-600">Sign Out</button>
                </div>
            </div>
        </div>
    </div>`;

  document.getElementById('profile-name').addEventListener('blur', (e) => validateInput(e.target, val => val.trim().length > 0, 'Name cannot be empty.'));
};

const renderProfilePicModal = () => {
  uploadedPfpFile = null;
  selectedAvatarUrl = null;

  const avatars = [
    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%23fca5a5\'/%3E%3Ctext x=\'50\' y=\'68\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3EðŸš€%3C/text%3E%3C/svg%3E',
    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%23fdba74\'/%3E%3Ctext x=\'50\' y=\'68\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3EðŸ’¡%3C/text%3E%3C/svg%3E',
    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%23fde047\'/%3E%3Ctext x=\'50\' y=\'68\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3EðŸŒŸ%3C/text%3E%3C/svg%3E',
    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%2386efac\'/%3E%3Ctext x=\'50\' y=\'68\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3EðŸ“š%3C/text%3E%3C/svg%3E',
    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%2393c5fd\'/%3E%3Ctext x=\'50\' y=\'68\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3EðŸ’»%3C/text%3E%3C/svg%3E',
    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%23a78bfa\'/%3E%3Ctext x=\'50\' y=\'68\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3EðŸŽ¨%3C/text%3E%3C/svg%3E',
    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%23f472b6\'/%3E%3Ctext x=\'50\' y=\'68\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3EðŸ•%3C/text%3E%3C/svg%3E',
    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%2367e8f9\'/%3E%3Ctext x=\'50\' y=\'68\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3EðŸ§ª%3C/text%3E%3C/svg%3E',
    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%2371717a\'/%3E%3Ctext x=\'50\' y=\'68\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3EðŸŽ®%3C/text%3E%3C/svg%3E',
    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%23f43f5e\'/%3E%3Ctext x=\'50\' y=\'68\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3Eâ¤ï¸%3C/text%3E%3C/svg%3E',
    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%23eab308\'/%3E%3Ctext x=\'50\' y=\'68\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3EðŸ˜‚%3C/text%3E%3C/svg%3E',
    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%2322c55e\'/%3E%3Ctext x=\'50\' y=\'68\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3EðŸš²%3C/text%3E%3C/svg%3E',
    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%2306b6d4\'/%3E%3Ctext x=\'50\' y=\'68\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3EðŸŒ%3C/text%3E%3C/svg%3E',
    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%238b5cf6\'/%3E%3Ctext x=\'50\' y=\'68\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3EðŸŽ“%3C/text%3E%3C/svg%3E',
    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%23d946ef\'/%3E%3Ctext x=\'50\' y=\'68\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3EðŸŽµ%3C/text%3E%3C/svg%3E',
    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%23f97316\'/%3E%3Ctext x=\'50\' y=\'68\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3EðŸ”%3C/text%3E%3C/svg%3E',
  ];

  profilePicModalContent.innerHTML = `
    <div class="p-6">
      <h2 class="text-2xl font-bold text-center mb-6 text-gray-900 dark:text-white">Change Profile Picture</h2>
      <div class="space-y-6">
        <div>
          <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-200">Upload a Photo</h3>
          <div id="pfp-drop-zone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-md">
            <div id="pfp-upload-prompt" class="space-y-1 text-center">
              <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
              <div class="flex text-sm text-gray-600 dark:text-gray-400">
                <label for="pfp-upload" class="relative cursor-pointer bg-white dark:bg-gray-800 rounded-md font-medium text-primary-600 hover:text-primary-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary-500">
                  <span>Upload a file</span>
                  <input id="pfp-upload" name="pfp-upload" type="file" class="sr-only" accept="image/*">
                </label>
                <p class="pl-1">or drag and drop</p>
              </div>
              <p class="text-xs text-gray-500">PNG, JPG, GIF</p>
            </div>
            <img id="pfp-preview" class="hidden mx-auto h-24 w-24 rounded-full object-cover"/>
          </div>
        </div>
        <div class="text-center text-gray-500 text-sm font-semibold">OR</div>
        <div>
          <h3 class="font-semibold mb-3 text-gray-800 dark:text-gray-200">Choose an Avatar</h3>
          <div id="avatar-grid" class="grid grid-cols-8 gap-3">
            ${avatars.map(avatar => `
              <img src="${avatar}" class="avatar-option rounded-full cursor-pointer transition-all duration-200 hover:scale-110 p-1 border-2 border-transparent" data-url="${avatar}">
              `).join('')}
          </div>
        </div>
      </div>
      <div class="flex justify-end space-x-3 mt-8">
        <button id="cancel-pfp-btn" class="px-5 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg font-semibold animated-btn">Cancel</button>
        <button id="save-pfp-btn" class="px-5 py-2 bg-primary-600 text-white rounded-lg font-semibold animated-btn">Save</button>
      </div>
    </div>
    `;
  profilePicModal.classList.add('show');
  setupPfpUploadListeners();
};

const renderChangePasswordModal = () => {
  changePasswordModalContent.innerHTML = `
    <form id="change-password-form" class="p-8 space-y-4" novalidate>
      <h2 class="text-2xl font-bold text-center text-gray-900 dark:text-white mb-6">Change Password</h2>
      <div>
        <label for="current-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Current Password</label>
        <input type="password" id="current-password" class="mt-1 w-full p-3 border dark:border-gray-600 rounded-lg bg-transparent" required autocomplete="current-password">
      </div>
      <div>
        <label for="new-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">New Password</label>
        <input type="password" id="new-password" class="mt-1 w-full p-3 border dark:border-gray-600 rounded-lg bg-transparent" required autocomplete="new-password">
      </div>
      <div>
        <label for="confirm-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Confirm New Password</label>
        <input type="password" id="confirm-password" class="mt-1 w-full p-3 border dark:border-gray-600 rounded-lg bg-transparent" required autocomplete="new-password">
      </div>
      <div class="flex justify-end space-x-4 pt-4">
        <button type="button" id="cancel-change-password-btn" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg font-semibold animated-btn">Cancel</button>
        <button type="submit" id="submit-change-password-btn" class="px-6 py-2 bg-primary-600 text-white rounded-lg font-semibold animated-btn flex items-center justify-center min-w-[140px]">Update Password</button>
      </div>
    </form>
    `;
  changePasswordModal.classList.add('show');
  document.getElementById('current-password').focus();
};

const renderPrivacyModal = () => {
    privacyModalContent.innerHTML = `
        <div class="flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50 rounded-t-xl">
                <h2 class="text-2xl font-bold text-primary-600 dark:text-primary-400">Privacy Policy</h2>
                <button class="close-policy-modal p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">&times;</button>
            </div>
            <div class="p-8 overflow-y-auto text-gray-600 dark:text-gray-300 space-y-6">
                <p class="text-sm text-gray-500"><strong>Last Updated:</strong> ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                <p>Welcome to CampusMart ("we," "our," or "us"). We are committed to protecting your privacy. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you use our application.</p>
                
                <div class="space-y-4">
                    <div class="p-4 bg-primary-50 dark:bg-gray-700/50 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">1. Information We Collect</h3>
                        <p class="mt-2">We may collect personal identification information from you when you register, place an order, or interact with our services. This includes your name and email address.</p>
                    </div>
                    <div class="p-4 bg-primary-50 dark:bg-gray-700/50 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">2. How We Use Your Information</h3>
                        <p class="mt-2">We use the information to personalize your experience, improve our application, process transactions securely, and send periodic emails regarding your orders or other relevant services.</p>
                    </div>
                    <div class="p-4 bg-primary-50 dark:bg-gray-700/50 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">3. Data Security</h3>
                        <p class="mt-2">We adopt appropriate data collection, storage, and security measures to protect against unauthorized access, alteration, or destruction of your personal information and transaction data.</p>
                    </div>
                    <div class="p-4 bg-primary-50 dark:bg-gray-700/50 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">4. Sharing Your Information</h3>
                        <p class="mt-2">We do not sell, trade, or rent your personal identification information. Your email is shared with a buyer/seller only to facilitate a transaction you've initiated.</p>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end bg-gray-50 dark:bg-gray-800/50 rounded-b-xl">
                <button class="close-policy-modal px-5 py-2 bg-primary-600 text-white rounded-lg font-semibold animated-btn">Close</button>
            </div>
        </div>
    `;
};

const renderTermsModal = () => {
    termsModalContent.innerHTML = `
        <div class="flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50 rounded-t-xl">
                <h2 class="text-2xl font-bold text-primary-600 dark:text-primary-400">Terms & Conditions</h2>
                <button class="close-policy-modal p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">&times;</button>
            </div>
            <div class="p-8 overflow-y-auto text-gray-600 dark:text-gray-300 space-y-6">
                <p class="text-sm text-gray-500"><strong>Last Updated:</strong> ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                <p>Please read these Terms and Conditions ("Terms") carefully before using the CampusMart application (the "Service"). Your access to and use of the Service is conditioned on your acceptance of and compliance with these Terms.</p>
                
                <div class="space-y-4">
                    <div class="p-4 bg-primary-50 dark:bg-gray-700/50 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">1. Accounts & Conduct</h3>
                        <p class="mt-2">When you create an account, you must provide accurate information. You agree not to post any material which is defamatory, offensive, or obscene. You are responsible for all content you post.</p>
                    </div>
                    <div class="p-4 bg-primary-50 dark:bg-gray-700/50 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">2. Transactions</h3>
                        <p class="mt-2">CampusMart is a platform for users to connect. We are not a party to any transaction. We do not guarantee the quality, safety, or legality of items advertised, the truth of listings, or the ability of users to complete a transaction.</p>
                    </div>
                    <div class="p-4 bg-primary-50 dark:bg-gray-700/50 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">3. Prohibited Items</h3>
                        <p class="mt-2">Listing illegal items, including but not limited to weapons, drugs, and stolen goods, is strictly prohibited and will result in immediate account termination and potential reporting to authorities.</p>
                    </div>
                    <div class="p-4 bg-primary-50 dark:bg-gray-700/50 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">4. Termination</h3>
                        <p class="mt-2">We may terminate or suspend access to our Service immediately, without prior notice, for any reason, including a breach of these Terms.</p>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end bg-gray-50 dark:bg-gray-800/50 rounded-b-xl">
                <button class="close-policy-modal px-5 py-2 bg-primary-600 text-white rounded-lg font-semibold animated-btn">Close</button>
            </div>
        </div>
    `;
};


// --- Chatbot Functions ---
const renderPopupChat = () => {
  popupChatWidget.innerHTML = `
    <div id="popup-chat-container" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl flex flex-col overflow-hidden border border-gray-200 dark:border-gray-700">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-gray-50 dark:bg-gray-800/50">
        <div class="flex items-center space-x-3">
          <img src="${campusBot.photoURL}" class="w-10 h-10 rounded-full object-cover">
          <h3 class="text-lg font-bold">${campusBot.displayName}</h3>
        </div>
        <button id="close-popup-chat-btn" class="p-1 text-gray-500 hover:text-gray-800 dark:hover:text-white text-2xl">&times;</button>
      </div>
      <div id="popup-chat-messages" class="flex-grow p-4 overflow-y-auto space-y-4 flex flex-col">
        <div class="w-fit max-w-[75%] p-3 rounded-xl shadow-sm bg-gray-200 dark:bg-gray-700 self-start">Hi there! How can I help you today?</div>
      </div>
      <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
        <form id="popup-chat-form" class="flex items-center space-x-2">
          <input type="text" id="popup-chat-input" placeholder="Ask a question..." class="w-full p-3 border dark:border-gray-600 rounded-lg bg-transparent" autocomplete="off" required>
          <button type="submit" aria-label="Send message" class="p-3 bg-primary-600 text-white rounded-lg animated-btn"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" transform="rotate(90)"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg></button>
        </form>
      </div>
    </div>
    <button id="open-popup-chat-btn" class="w-16 h-16 bg-primary-600 text-white rounded-full shadow-lg flex items-center justify-center animated-btn">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
    </button>
    `;
};

const handlePopupSendMessage = (e) => {
    e.preventDefault();
    const input = document.getElementById('popup-chat-input');
    const messagesContainer = document.getElementById('popup-chat-messages');
    if (!input || !messagesContainer) return;

    const text = input.value.trim();
    if (!text) return;

    const filteredText = filterProfanity(text); // Assumes you have a filterProfanity function
    input.value = '';

    // --- Display User's Message ---
    const userMessageEl = document.createElement('div');
    userMessageEl.className = 'w-fit max-w-[75%] p-3 rounded-xl shadow-sm bg-primary-600 text-white self-end';
    userMessageEl.textContent = filteredText;
    messagesContainer.appendChild(userMessageEl);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    // --- Bot Logic and Response ---
    setTimeout(() => {
        let replyText;
        let intentFound = false;

        // Loop through intents to find a match
        for (const intent of chatbotIntents) {
            for (const keyword of intent.keywords) {
                if (filteredText.match(keyword)) {
                    replyText = intent.handler(filteredText);
                    intentFound = true;
                    break;
                }
            }
            if (intentFound) break;
        }

        // If no intent was matched, use a fallback response
        if (!intentFound) {
            replyText = "I'm sorry, I'm not sure how to help with that. Try asking me 'help' to see what I can do.";
        }

        // --- Display Bot's Message ---
        const botMessageEl = document.createElement('div');
        botMessageEl.className = 'w-fit max-w-[75%] p-3 rounded-xl shadow-sm bg-gray-200 dark:bg-gray-700 self-start';
        // Use innerHTML to render line breaks from the help message
        botMessageEl.innerHTML = replyText.replace(/\n/g, '<br>'); 
        messagesContainer.appendChild(botMessageEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 1000);
};


// --- Authentication & Profile Logic ---
const handleSignUp = async (e) => { e.preventDefault(); const name = document.getElementById('signup-name').value; const email = document.getElementById('signup-email').value; const password = document.getElementById('signup-password').value; if(password.length < 6) { showMessage('Password must be at least 6 characters.', 'error'); return; } try { const userCredential = await auth.createUserWithEmailAndPassword(email, password); await userCredential.user.updateProfile({ displayName: name }); await db.collection('users').doc(userCredential.user.uid).set({ uid: userCredential.user.uid, displayName: name, email: email, photoURL: null, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); await userCredential.user.sendEmailVerification(); showMessage('Account created! Please check your email to verify.', 'success'); renderAuthModal('verify'); } catch (error) { showMessage(error.message, 'error'); } };
const handleSignIn = async (e) => {
    e.preventDefault();
    const email = document.getElementById('signin-email').value;
    const password = document.getElementById('signin-password').value;
    try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        // If sign-in is successful but email is not verified...
        if (!userCredential.user.emailVerified) {
            // ...don't sign out. The onAuthStateChanged listener will now catch this
            // unverified user and display the correct verification modal.
            showMessage('Please verify your email to continue.', 'error');
        }
        // If the email IS verified, the onAuthStateChanged listener will handle the UI update automatically.
    } catch (error) {
        showMessage(error.message, 'error');
    }
};
const handleResendVerification = async () => {
  // Get a reference to the button in the UI
  const btn = document.getElementById('resend-verification-btn');

  // 1. Check if a user is actually signed in. This is crucial.
  if (!auth.currentUser) {
    showMessage('No user found. Please sign in again to receive a new link.', 'error');
    renderAuthModal('signin'); // Send the user back to the sign-in screen
    return;
  }

  // 2. Prevent the user from spamming the button if it's already disabled
  if (btn.disabled) return;

  try {
    // 3. Disable the button and show a loading spinner for user feedback
    btn.disabled = true;
    btn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`;

    // 4. Call the core Firebase Authentication method to send the email
    await auth.currentUser.sendEmailVerification();
    showMessage('A new verification email has been sent. Please check your inbox.', 'success');

  } catch (error) {
    // 5. Handle potential errors gracefully
    if (error.code === 'auth/too-many-requests') {
      showMessage('Too many requests. Please wait before trying again.', 'error');
    } else {
      showMessage(`Error sending email: ${error.message}`, 'error');
    }
  } finally {
    // 6. Set a cooldown period to prevent spam, then re-enable the button
    setTimeout(() => {
      // Check if the button still exists before trying to change it
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = 'Resend Verification Email';
      }
    }, 10000); // 10-second cooldown
  }
};
const handleSignOut = () => { showConfirmModal("Are you sure you want to sign out?", () => auth.signOut()); };
const handleUpdateProfile = async (e) => { e.preventDefault(); const nameInput = document.getElementById('profile-name'); if (!validateInput(nameInput, val => val.trim().length > 0, 'Name cannot be empty.')) return; const newName = nameInput.value; if (newName === currentUser.displayName) return; const btn = document.getElementById('update-profile-btn'); btn.disabled = true; btn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`; try { await currentUser.updateProfile({ displayName: newName }); const userDocRef = db.collection('users').doc(currentUser.uid); const productsRef = db.collection('products').where('sellerId', '==', currentUser.uid); const productsSnapshot = await productsRef.get();; batch.update(userDocRef, { displayName: newName }); productsSnapshot.docs.forEach(doc => { batch.update(doc.ref, { sellerName: newName }); }); await batch.commit(); showMessage('Profile updated successfully!', 'success'); renderHeaderActions(); renderProfilePage(); } catch (error) { showMessage('Error updating profile: ' + error.message, 'error'); } finally { btn.disabled = false; btn.innerHTML = 'Save Changes'; } };

const handleUpdateProfilePicture = async () => {
  const btn = document.getElementById('save-pfp-btn');
  btn.disabled = true;
  btn.innerHTML = `<div class="animate const batch = db.batch()-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`;

  let photoURL;
  try {
    if (selectedAvatarUrl) {
      photoURL = selectedAvatarUrl;
    } else if (uploadedPfpFile) {
      photoURL = await uploadToCloudinary(uploadedPfpFile);
      if (!photoURL) throw new Error("Cloudinary upload failed.");
    } else {
      showMessage('Please select an image or an avatar.', 'error');
      btn.disabled = false;
      btn.innerHTML = 'Save';
      return;
    }

    await currentUser.updateProfile({ photoURL: photoURL });
    await db.collection('users').doc(currentUser.uid).update({ photoURL: photoURL });
    // Also update the photoURL on existing products and offers
    const productsRef = db.collection('products').where('sellerId', '==', currentUser.uid);
    const productsSnapshot = await productsRef.get();
    const batch = db.batch();
    productsSnapshot.docs.forEach(doc => {
      batch.update(doc.ref, { sellerPhotoURL: photoURL });
    });
    await batch.commit();

    showMessage('Profile picture updated!', 'success');
    profilePicModal.classList.remove('show');
    renderHeaderActions();
    renderProfilePage();
  } catch (error) {
    showMessage(`Error updating picture: ${error.message}`, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Save';
  }
};

const handleChangePassword = async (e) => {
  e.preventDefault();
  const currentPassword = document.getElementById('current-password').value;
  const newPassword = document.getElementById('new-password').value;
  const confirmPassword = document.getElementById('confirm-password').value;

  if (newPassword !== confirmPassword) {
    showMessage('New passwords do not match.', 'error');
    return;
  }
  if (newPassword.length < 6) {
    showMessage('New password must be at least 6 characters long.', 'error');
    return;
  }

  const btn = document.getElementById('submit-change-password-btn');
  btn.disabled = true;
  btn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`;

  try {
    const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, currentPassword);
    await currentUser.reauthenticateWithCredential(credential);
    await currentUser.updatePassword(newPassword);
    showMessage('Password updated successfully!', 'success');
    changePasswordModal.classList.remove('show');
  } catch (error) {
    showMessage(`Error updating password: ${error.message}`, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Update Password';
  }
};

// --- Product & Cart Logic ---
const addProduct = async (e) => {
  e.preventDefault();
  const nameInput = document.getElementById('productName');
  const descInput = document.getElementById('description');
  const isNameValid = validateInput(nameInput, val => val.trim().length > 2, 'Name must be longer than 2 characters.');
  const isDescValid = validateInput(descInput, val => val.trim().length > 10, 'Description must be longer than 10 characters.');

  if (!isNameValid || !isDescValid) {
    showMessage('Please fix the errors before submitting.', 'error');
    return;
  }

  const submitBtn = document.getElementById('list-item-btn');
  if (!uploadedProductFile) {
    showMessage('Please upload an image for the product.', 'error');
    return;
  }
  submitBtn.disabled = true;
  submitBtn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`;

  try {
    const imageUrl = await uploadToCloudinary(uploadedProductFile);
    if (!imageUrl) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'List My Item';
      return;
    }

    const product = {
      name: nameInput.value,
      description: descInput.value,
      price: parseFloat(document.getElementById('price').value),
      category: document.getElementById('category').value,
      isTradeable: document.getElementById('isTradeable').checked,
      imageUrl: imageUrl,
      sellerId: currentUser.uid,
      sellerName: currentUser.displayName,
      sellerEmail: currentUser.email,
      sellerPhotoURL: currentUser.photoURL,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      status: 'available'
    };
await db.collection('products').add(product);

    showMessage('Product listed successfully!', 'success');
    e.target.reset();
    document.getElementById('image-preview').classList.add('hidden');
    document.getElementById('image-upload-prompt').classList.remove('hidden');
    uploadedProductFile = null;
    setActiveTab('my-listings');

  } catch (error) {
    showMessage(`Error listing product: ${error.message}`, 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = 'List My Item';
  }
};

const handleDeleteProduct = (productId) => {
  const product = products.find(p => p.id === productId);
  if (!product) return;

  showConfirmModal("Are you sure you want to delete this item? This action cannot be undone.", async () => {
    try {
      await db.collection('products').doc(productId).delete();
      showMessage('Item deleted successfully!', 'success');
    } catch (error) {
      showMessage(`Error deleting item: ${error.message}`, 'error');
    }
  });
};

const handleAddLostAndFoundReport = async (e) => {
  e.preventDefault();
  const form = e.target;
  const title = form.querySelector('#lostFoundTitle').value;
  const description = form.querySelector('#lostFoundDescription').value;
  const location = form.querySelector('#lostFoundLocation').value;
  const reportType = form.querySelector('#reportType').value;
  const collectionPoint = form.querySelector('#lostFoundCollectionPoint')?.value || '';

  if (!title || !description || !location || (reportType === 'found' && !collectionPoint)) {
    showMessage('Please fill out all required fields.', 'error');
    return;
  }
  if (!uploadedLostFoundFile) {
    showMessage('Please upload an image of the item.', 'error');
    return;
  }

  const submitBtn = form.querySelector('#submit-lost-found-btn');
  submitBtn.disabled = true;
  submitBtn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`;

  try {
    const imageUrl = await uploadToCloudinary(uploadedLostFoundFile);
    if (!imageUrl) throw new Error("Image upload failed.");

    const report = {
      title,
      description,
      location,
      reportType,
      collectionPoint: collectionPoint || null,
      imageUrl,
      reporterId: currentUser.uid,
      reporterName: currentUser.displayName,
      reporterEmail: currentUser.email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      status: 'active'
    };

    await db.collection('lost_and_found').add(report);
    showMessage('Report submitted successfully!', 'success');
    lostAndFoundModal.classList.remove('show');
    uploadedLostFoundFile = null;

  } catch (error) {
    showMessage(`Error submitting report: ${error.message}`, 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = 'Submit Report';
  }
};

const handleDeleteLostAndFoundItem = (itemId) => {
  const item = lostAndFoundItems.find(i => i.id === itemId);
  if (!item || item.reporterId !== currentUser.uid) return;

  showConfirmModal("Are you sure you want to delete this report? This cannot be undone.", async () => {
    try {
      await db.collection('lost_and_found').doc(itemId).delete();
      showMessage('Report deleted successfully.', 'success');
    } catch (error) {
      showMessage(`Failed to delete report: ${error.message}`, 'error');
    }
  });
};

const addToCart = (productId) => {
  if (!currentUser) {
    showMessage('Please sign in to add items to your cart.', 'error');
    return;
  }
  const product = products.find(p => p.id === productId);
  if (!product || product.status !== 'available') {
    showMessage('This item is not available for purchase.', 'error');
    return;
  }

  if (cart[productId]) {
    showMessage('This item is already in your cart.', 'success');
    return;
  }
  showMessage('Added to cart!', 'success');

  const cartItemRef = db.collection('carts').doc(currentUser.uid).collection('items').doc(productId);
  cartItemRef.set({
    productId: product.id,
    name: product.name,
    price: product.price,
    imageUrl: product.imageUrl,
    quantity: 1
  }).catch(error => {
    console.error("Detailed Add to Cart Error:", error);
    showMessage('Failed to add to cart. Please try again.', 'error');
  });
};
const removeFromCart = async (productId) => { if (!currentUser) return; await db.collection('carts').doc(currentUser.uid).collection('items').doc(productId).delete(); showMessage('Item removed from cart.', 'success'); };
const handleCheckout = async () => {
    const confirmBtn = document.getElementById('confirm-payment-btn');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`;

    try {
        await new Promise(res => setTimeout(res, 1500)); // Simulate payment processing
        const cartItems = Object.values(cart);
        const total = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

        const orderData = {
            userId: currentUser.uid,
            userName: currentUser.displayName,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            total: total,
            items: cartItems.map(({ id, ...rest }) => ({ ...rest }))
        };
        
        // This batch will now succeed because of your new security rule
        const batch = db.batch();

        // Action 1: Create the new order document
        const orderRef = db.collection('orders').doc(); // Create a reference first
        batch.set(orderRef, orderData);

        // Action 2: Update the status of each product to 'sold'
        cartItems.forEach(item => {
            const productRef = db.collection('products').doc(item.id);
            batch.update(productRef, { status: 'sold' });
        });

        // Action 3: Clear the user's cart
        const cartItemsRef = db.collection('carts').doc(currentUser.uid).collection('items');
        const cartSnapshot = await cartItemsRef.get();
        cartSnapshot.forEach(doc => {
            batch.delete(doc.ref);
        });

        // Atomically commit all changes
        await batch.commit();
        
        checkoutModal.classList.remove('show');
        triggerConfetti();
        showMessage('Purchase complete! The seller has been notified.', 'success');
        setActiveTab('orders');

    } catch (error) {
        showMessage('Payment failed. Please try again. ' + error.message, 'error');
    } finally {
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = 'Pay Now';
    }
};


// --- TRADE/BARTER LOGIC ---

const renderMakeOfferModal = (productId) => {
  uploadedTradeOfferFile = null;
  tradeOfferModalContent.innerHTML = `
    <form id="trade-offer-form" class="p-6 space-y-4" novalidate data-product-id="${productId}">
      <h2 class="text-2xl font-bold text-center text-gray-900 dark:text-white mb-4">Make a Trade Offer</h2>
      <div>
        <label for="tradeOfferText" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Your Offer</label>
        <textarea id="tradeOfferText" placeholder="Describe what you're offering in trade..." class="mt-1 w-full p-3 border dark:border-gray-600 rounded-lg bg-transparent" rows="4" required></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Your Item's Image (Optional)</label>
        <div id="trade-offer-drop-zone" class="mt-1 flex justify-center items-center w-full h-48 rounded-lg bg-gray-50 dark:bg-gray-700 cursor-pointer">
          <div id="trade-offer-upload-prompt" class="text-center text-gray-500 dark:text-gray-400">
            <svg class="mx-auto h-12 w-12" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            <p class="mt-2 text-sm">Drag & drop or click to upload</p>
            <input type="file" id="tradeOfferImageUpload" class="hidden" accept="image/*">
          </div>
          <img id="trade-offer-image-preview" class="hidden w-full h-full object-contain rounded-lg p-2">
        </div>
      </div>
      <div class="flex justify-end space-x-4 pt-4">
        <button type="button" id="cancel-trade-offer-btn" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg font-semibold animated-btn">Cancel</button>
        <button type="submit" id="submit-trade-offer-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg font-semibold animated-btn flex items-center justify-center min-w-[120px]">Submit Offer</button>
      </div>
    </form>
    `;
  tradeOfferModal.classList.add('show');
  setupImageUploadListeners('trade-offer-drop-zone', 'tradeOfferImageUpload', 'trade-offer-image-preview', 'trade-offer-upload-prompt', file => uploadedTradeOfferFile = file);
};

const handleTradeOfferSubmit = async (e) => {
  e.preventDefault();
  const form = e.target;
  const productId = form.dataset.productId;
  const offerText = form.querySelector('#tradeOfferText').value;

  if (!offerText.trim()) {
    showMessage('Please describe your offer.', 'error');
    return;
  }

  const submitBtn = form.querySelector('#submit-trade-offer-btn');
  submitBtn.disabled = true;
  submitBtn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`;

  try {
    let offerImageUrl = null;
    if (uploadedTradeOfferFile) {
      offerImageUrl = await uploadToCloudinary(uploadedTradeOfferFile);
    }

    const offer = {
      offerText: filterProfanity(offerText),
      offerImageUrl,
      offererId: currentUser.uid,
      offererName: currentUser.displayName,
      offererEmail: currentUser.email,
      offererPhotoURL: currentUser.photoURL,
      status: 'pending',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection('products').doc(productId).collection('offers').add(offer);
    showMessage('Trade offer submitted successfully!', 'success');
    tradeOfferModal.classList.remove('show');
  } catch (error) {
    showMessage(`Error submitting offer: ${error.message}`, 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = 'Submit Offer';
  }
};

const renderSellerOffersView = (productId) => {
  const container = document.getElementById('offers-section');
  if (!container) return;

  container.innerHTML = `<div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
    <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Received Trade Offers</h3>
    <div id="offers-list" class="space-y-4">
      <p class="text-gray-500">Loading offers...</p>
    </div>
    </div>`;

  const offersList = document.getElementById('offers-list');
  offersUnsubscribe = db.collection('products').doc(productId).collection('offers')
    .orderBy('createdAt', 'desc')
    .onSnapshot(snapshot => {
      if (snapshot.empty) {
        offersList.innerHTML = `<p class="text-gray-500 dark:text-gray-400">You have not received any offers for this item yet.</p>`;
        return;
      }
      offersList.innerHTML = '';
      snapshot.docs.forEach(doc => {
        const offer = { id: doc.id, ...doc.data() };
        const offerCard = document.createElement('div');
        offerCard.className = `p-4 border dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/50`;

        let statusBadge;
        if (offer.status === 'accepted') {
          statusBadge = `<span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full">Accepted</span>`;
        } else if (offer.status === 'rejected') {
          statusBadge = `<span class="px-2 py-1 text-xs font-semibold text-red-800 bg-red-200 rounded-full">Rejected</span>`;
        } else {
          statusBadge = `<span class="px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-200 rounded-full">Pending</span>`;
        }

        offerCard.innerHTML = `
          <div class="flex justify-between items-start gap-4">
            <div class="flex items-start gap-3">
              <img src="${offer.offererPhotoURL || 'https://placehold.co/40x40/dbeafe/1e40af?text=?'}" class="w-10 h-10 rounded-full object-cover">
              <div>
                <p class="font-semibold text-gray-800 dark:text-white">${offer.offererName}</p>
                <p class="text-sm text-gray-600 dark:text-gray-300">${offer.offerText}</p>
              </div>
            </div>
            ${statusBadge}
          </div>
          ${offer.offerImageUrl ? `<div class="mt-3"><img src="${offer.offerImageUrl}" class="max-w-[150px] max-h-[150px] rounded-md object-cover border dark:border-gray-600"></div>` : ''}
          ${offer.status === 'pending' ? `
            <div class="mt-4 flex justify-end items-center gap-3">
              <button class="reject-offer-btn px-4 py-1.5 bg-red-500 text-white rounded-lg font-semibold text-sm" data-offer-id="${offer.id}" data-product-id="${productId}">Reject</button>
              <button class="accept-offer-btn px-4 py-1.5 bg-green-500 text-white rounded-lg font-semibold text-sm" data-offer-id="${offer.id}" data-product-id="${productId}" data-offerer-id="${offer.offererId}">Accept</button>
            </div>
            ` : ''}
          `;
        offersList.appendChild(offerCard);
      });
    }, error => {
      console.error("Error fetching offers:", error);
      offersList.innerHTML = `<p class="text-red-500">Could not load offers.</p>`;
    });
};

const handleAcceptOffer = async (offerId, productId, offererId) => {
  showConfirmModal("Accepting this will mark the item as 'Traded' and reject all other offers. This cannot be undone. Continue?", async () => {
    const productRef = db.collection('products').doc(productId);
    const offerRef = productRef.collection('offers').doc(offerId);
    const otherOffersQuery = productRef.collection('offers').where('status', '==', 'pending');

    try {
      const batch = db.batch();
      // 1. Mark the item as traded
      batch.update(productRef, { status: 'traded' });
      // 2. Mark the selected offer as accepted
      batch.update(offerRef, { status: 'accepted' });

      // 3. Reject all other pending offers
      const otherOffersSnapshot = await otherOffersQuery.get();
      otherOffersSnapshot.forEach(doc => {
        if (doc.id !== offerId) {
          batch.update(doc.ref, { status: 'rejected' });
        }
      });

      await batch.commit();
      showMessage('Offer accepted! The item has been marked as traded.', 'success');
    } catch (error) {
      showMessage(`Failed to accept offer: ${error.message}`, 'error');
    }
  });
};

const handleRejectOffer = async (offerId, productId) => {
  const offerRef = db.collection('products').doc(productId).collection('offers').doc(offerId);
  try {
    await offerRef.update({ status: 'rejected' });
    showMessage('Offer rejected.', 'success');
  } catch (error) {
    showMessage(`Failed to reject offer: ${error.message}`, 'error');
  }
};

// --- Universal Upload & Event Listeners Setup ---
function setupImageUploadListeners(dropZoneId, fileInputId, previewId, promptId, callback) {
  const dropZone = document.getElementById(dropZoneId);
  const fileInput = document.getElementById(fileInputId);
  const preview = document.getElementById(previewId);
  const prompt = document.getElementById(promptId);
  if (!dropZone) return;

  const handleFile = (file) => {
    if (file && file.type.startsWith('image/')) {
      callback(file);
      const reader = new FileReader();
      reader.onload = (e) => {
        preview.src = e.target.result;
        preview.classList.remove('hidden');
        prompt.classList.add('hidden');
      };
      reader.readAsDataURL(file);
    } else {
      showMessage('Please select a valid image file.', 'error');
    }
  };

  dropZone.onclick = () => fileInput.click();
  fileInput.onchange = (e) => handleFile(e.target.files[0]);
  dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); };
  dropZone.ondragleave = () => dropZone.classList.remove('drag-over');
  dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFile(e.dataTransfer.files[0]); };
}

function setupPfpUploadListeners() {
  const dropZone = document.getElementById('pfp-drop-zone');
  const fileInput = document.getElementById('pfp-upload');
  const preview = document.getElementById('pfp-preview');
  const prompt = document.getElementById('pfp-upload-prompt');
  const avatarGrid = document.getElementById('avatar-grid');
  if (!dropZone) return;

  const handleFile = (file) => {
    if (file && file.type.startsWith('image/')) {
      uploadedPfpFile = file;
      selectedAvatarUrl = null;

      const reader = new FileReader();
      reader.onload = (e) => {
        preview.src = e.target.result;
        prompt.classList.add('hidden');
        preview.classList.remove('hidden');
        avatarGrid.querySelectorAll('.avatar-option').forEach(el => el.style.border = '2px solid transparent');
      };
      reader.readAsDataURL(file);
    } else { showMessage('Please select a valid image file.', 'error'); }
  };

  dropZone.onclick = () => fileInput.click();
  fileInput.onchange = (e) => handleFile(e.target.files[0]);
  dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); };
  dropZone.ondragleave = () => dropZone.classList.remove('drag-over');
  dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFile(e.dataTransfer.files[0]); };

  avatarGrid.addEventListener('click', e => {
    const avatar = e.target.closest('.avatar-option');
    if (avatar) {
      uploadedPfpFile = null;
      selectedAvatarUrl = avatar.dataset.url;
      prompt.classList.remove('hidden');
      preview.classList.add('hidden');
      avatarGrid.querySelectorAll('.avatar-option').forEach(el => el.style.border = '2px solid transparent');
      avatar.style.border = '2px solid #2563eb';
    }
  });
}

// --- App Initialization ---
auth.onAuthStateChanged(user => {
  if (emailVerificationInterval) clearInterval(emailVerificationInterval);
  productUnsubscribe(); cartUnsubscribe(); ordersUnsubscribe(); lostAndFoundUnsubscribe(); offersUnsubscribe();

  if (user && user.emailVerified) {
    const userDocRef = db.collection('users').doc(user.uid);
    userDocRef.get().then(doc => {
      if (!doc.exists) {
        userDocRef.set({
          uid: user.uid,
          displayName: user.displayName,
          email: user.email,
          photoURL: user.photoURL,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }).catch(error => {
      console.error("Error checking for user document:", error);
    });

    currentUser = user;
    authModal.classList.remove('show');
    if (!sessionStorage.getItem('welcomeShown')) { showWelcomeAnimation(user); sessionStorage.setItem('welcomeShown', 'true'); }
    else { appContainer.classList.remove('opacity-0'); }

    productUnsubscribe = db.collection('products').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
      products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const activeTab = document.querySelector('.tab-content.active');
      if (activeTab && activeTab.id !== 'product-detail-tab') {
        setActiveTab(activeTab.id.replace('-tab', ''), true);
      }
    });
    cartUnsubscribe = db.collection('carts').doc(currentUser.uid).collection('items').onSnapshot(snapshot => {
      cart = {};
      snapshot.forEach(doc => { cart[doc.id] = { id: doc.id, ...doc.data() }; });
      renderCart();
    });
    ordersUnsubscribe = db.collection('orders').where('userId', '==', currentUser.uid).orderBy('createdAt', 'desc').onSnapshot(snapshot => {
      orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const activeTab = document.querySelector('.tab-content.active');
      if(activeTab && activeTab.id === 'orders-tab') renderOrdersPage();
    });

    lostAndFoundUnsubscribe = db.collection('lost_and_found').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
      lostAndFoundItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const activeTab = document.querySelector('.tab-content.active');
      if (activeTab && activeTab.id === 'lost-and-found-tab') {
        filterAndRenderLostFoundItems();
      } else if (activeTab && activeTab.id === 'home-tab') {
        renderHomepageLostAndFoundPreview();
      }
    });

    renderHeaderActions();
    renderPopupChat();
    setActiveTab('home');
  } else {
    currentUser = null; products = []; cart = {}; orders = []; lostAndFoundItems = [];
    navigationHistory = ['home'];
    sessionStorage.removeItem('welcomeShown');
    appContainer.classList.add('opacity-0');
    authModal.classList.add('show');
    if (user && !user.emailVerified) {
      renderAuthModal('verify');
    } else {
      renderAuthModal('signin');
    }
    renderHeaderActions();
    popupChatWidget.innerHTML = '';
  }
});

document.body.addEventListener('click', (e) => {
     // Add this for the "Clear Order History" button
    if (e.target.closest('#clear-order-history-btn')) {
        handleClearOrderHistory();
        return;
    }

    // Add this for the "Mark as Resolved" button
    const resolveBtn = e.target.closest('.resolve-lost-found-btn');
    if (resolveBtn) {
        const { id, status } = resolveBtn.dataset;
        handleLostFoundStatusChange(id, status);
        return;
    }

  const navItem = e.target.closest('[data-tab]');
  if(navItem) setActiveTab(navItem.dataset.tab);

  const categoryCard = e.target.closest('[data-category]');
  if (categoryCard) {
    const category = categoryCard.dataset.category;
    setActiveTab('buy');
    const categoryFilter = document.querySelector('#buy-tab #filter-category');
    if (categoryFilter) {
      categoryFilter.value = category;
      filterAndRenderProducts(false);
    }
  }

  if(e.target.id === 'go-back-btn') { handleGoBack(); return; }

  if(e.target.id === 'show-signup') renderAuthModal('signup');
  if(e.target.id === 'show-signin') renderAuthModal('signin');
  if(e.target.id === 'sign-in-btn') { authModal.classList.add('show'); authModal.querySelector('input')?.focus(); }
  if(e.target.id === 'sign-out-btn') handleSignOut();
  if(e.target.closest('#google-signin-btn')) handleGoogleSignIn();

  if(e.target.closest('#theme-toggle-btn')) toggleTheme();

  if(e.target.closest('#cart-btn')) { cartDrawer.classList.add('open'); cartOverlay.classList.remove('hidden'); cartOverlay.style.opacity = '1'; document.getElementById('close-cart-btn')?.focus(); }
  if(e.target.id === 'close-cart-btn' || e.target.id === 'cart-overlay') { cartDrawer.classList.remove('open'); cartOverlay.style.opacity = '0'; setTimeout(() => cartOverlay.classList.add('hidden'), 300); }

  const addToCartBtn = e.target.closest('.add-to-cart-btn');
  if(addToCartBtn) { addToCart(addToCartBtn.dataset.id); return; }
  const deleteProductBtn = e.target.closest('.delete-product-btn');
  if(deleteProductBtn) { handleDeleteProduct(deleteProductBtn.dataset.id); return; }
  const removeFromCartBtn = e.target.closest('.remove-from-cart-btn');
  if (removeFromCartBtn) { removeFromCart(removeFromCartBtn.dataset.id); return; }

  const contactBtn = e.target.closest('.contact-seller-btn');
  if(contactBtn) { e.stopPropagation(); return; }

  const viewDetailsAction = e.target.closest('[data-action="view-details"]');
  if (viewDetailsAction) {
    const productId = viewDetailsAction.dataset.id;
    const product = products.find(p => p.id === productId);
    if (product) { renderProductDetailPage(product); setActiveTab('product-detail'); }
    return;
  }

  const passwordToggle = e.target.closest('.password-toggle');
  if (passwordToggle) {
    const input = passwordToggle.previousElementSibling;
    const eyeIcon = passwordToggle.querySelector('.eye-icon');
    const eyeSlashIcon = passwordToggle.querySelector('.eye-slash-icon');
    if (input.type === 'password') {
      input.type = 'text';
      eyeIcon.classList.add('hidden');
      eyeSlashIcon.classList.remove('hidden');
    } else {
      input.type = 'password';
      eyeIcon.classList.remove('hidden');
      eyeSlashIcon.classList.add('hidden');
    }
    return;
  }

  if(e.target.id === 'checkout-btn') { cartDrawer.classList.remove('open'); cartOverlay.style.opacity = '0'; setTimeout(() => cartOverlay.classList.add('hidden'), 300); renderCheckoutModal(); }
  if(e.target.id === 'cancel-checkout-btn') checkoutModal.classList.remove('show');
  if(e.target.id === 'confirm-payment-btn') handleCheckout();

  if(e.target.id === 'change-pic-btn') { renderProfilePicModal(); profilePicModal.querySelector('button, input, [tabindex="0"]')?.focus(); }
  if(e.target.id === 'cancel-pfp-btn') profilePicModal.classList.remove('show');
  if(e.target.id === 'save-pfp-btn') handleUpdateProfilePicture();

  if(e.target.id === 'change-password-btn') renderChangePasswordModal();
  if(e.target.id === 'cancel-change-password-btn') changePasswordModal.classList.remove('show');

  const openPopupBtn = e.target.closest('#open-popup-chat-btn');
  const closePopupBtn = e.target.closest('#close-popup-chat-btn');
  const popupContainer = document.getElementById('popup-chat-container');
  if (openPopupBtn) {
    popupContainer?.classList.add('open');
    openPopupBtn.classList.add('hidden');
  }
  if (closePopupBtn) {
    popupContainer?.classList.remove('open');
    document.getElementById('open-popup-chat-btn')?.classList.remove('hidden');
  }

  const addLostFoundBtn = e.target.closest('.add-lost-found-btn');
  if (addLostFoundBtn) {
    const reportType = addLostFoundBtn.dataset.type;
    renderLostAndFoundModal(reportType);
  }
  const deleteLostFoundBtn = e.target.closest('.delete-lost-found-btn');
  if(deleteLostFoundBtn) { handleDeleteLostAndFoundItem(deleteLostFoundBtn.dataset.id); return; }

  if (e.target.id === 'cancel-lost-found-btn') {
    lostAndFoundModal.classList.remove('show');
  }
  const makeTradeOfferBtn = e.target.closest('.make-trade-offer-btn');
  if (makeTradeOfferBtn) {
    renderMakeOfferModal(makeTradeOfferBtn.dataset.productId);
  }
  if (e.target.id === 'cancel-trade-offer-btn') {
    tradeOfferModal.classList.remove('show');
  }

  const acceptOfferBtn = e.target.closest('.accept-offer-btn');
  if(acceptOfferBtn) { handleAcceptOffer(acceptOfferBtn.dataset.offerId, acceptOfferBtn.dataset.productId, acceptOfferBtn.dataset.offererId); }
  const rejectOfferBtn = e.target.closest('.reject-offer-btn');
  if(rejectOfferBtn) { handleRejectOffer(rejectOfferBtn.dataset.offerId, rejectOfferBtn.dataset.productId); }

if (e.target.id === 'terms-link') {
    e.preventDefault();
    renderTermsModal(); 
    termsModal.classList.add('show'); // Show the terms modal
}

const closePolicyBtn = e.target.closest('.close-policy-modal');
if (closePolicyBtn) {
    
    closePolicyBtn.closest('.modal').classList.remove('show');
}
if (e.target.id === 'privacy-link') {
    e.preventDefault();
    renderPrivacyModal(); 
    privacyModal.classList.add('show'); // Show the privacy modal
}
});

document.body.addEventListener('submit', (e) => {
  e.preventDefault();
  const targetId = e.target.id;
  if(targetId === 'signup-form') handleSignUp(e);
  else if(targetId === 'signin-form') handleSignIn(e);
  else if(targetId === 'add-product-form') addProduct(e);
  else if(targetId === 'update-profile-form') handleUpdateProfile(e);
  else if(targetId === 'popup-chat-form') handlePopupSendMessage(e);
  else if(targetId === 'lost-and-found-form') handleAddLostAndFoundReport(e);
  else if(targetId === 'trade-offer-form') handleTradeOfferSubmit(e);
  else if(targetId === 'change-password-form') handleChangePassword(e);
});

document.getElementById('footer-date').textContent = new Date().getFullYear();
window.addEventListener('scroll', () => header.classList.toggle('shadow-lg', window.scrollY > 10));
});
</script>
</body>
</html>
